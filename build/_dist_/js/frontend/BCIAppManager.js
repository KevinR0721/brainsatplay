var T=Object.defineProperty;var b=(C,a,d)=>(typeof a!="symbol"&&(a+=""),a in C?T(C,a,{enumerable:!0,configurable:!0,writable:!0,value:d}):C[a]=d);import{page_template as x,appletbox_template as z,appletselect_template as A,filemenu_template as j,file_template as q,login_template as U}from"./menus/UITemplates.js";import{AppletManager as B}from"./utils/AppletManager.js";import{CSV as M}from"../general/csv.js";import{StateManager as G}from"./utils/StateManager.js";import{DOMFragment as y}from"./utils/DOMFragment.js";import*as I from"../../../_snowpack/pkg/browserfs.js";const n=I.BFSRequire("fs"),R=I.BFSRequire("buffer").Buffer;export class BCIAppManager{constructor(a=null,d=[],r=[],h=!1){b(this,"setupUITemplates",()=>{let a=`
        <div class="app">
        <div id="sidebar-container">
            <div id="sidebar">
            <div id="sidebar-inner">
                <div class="logo-container">
                    <img class="logo" src="./logo512.png">
                </div>
                <div id="device-menu" class="collapsible-container">
                    <button class="collapsible"><div class="img-cont"><img src="./_dist_/assets/wave-square-solid.svg"><span>Device Manager</span></div></button>
                    <div class="content">
                    </div>
                </div>
                <div id="applet-menu" class="collapsible-container">
                    <button class="collapsible"><div class="img-cont"><img src="./_dist_/assets/th-large-solid.svg"><span>Applets</span></div></button>
                    <div class="content">
                    </div>
                </div>
                <div class="collapsible-container">
                    <button class="collapsible">
                    <div class="img-cont">
                    <img src="./_dist_/assets/folder-solid.svg">
                    <span>File Manager</span>
                    </div>
                    </button>
                    <div id="filecontainer" class="content">
                    <span style="font-size: 80%;">File Manager</span>
                    <hr>
                    </div>
                </div>
                <div id="profile-menu" class="collapsible-container">
                    <button class="collapsible"><div class="img-cont"><img src="./_dist_/assets/user-solid.svg"><span>Profile</span></div></button>
                    <div class="content">
                    <span style="font-size: 80%;">Profile</span>
                    <hr>
                    </div>
                </div>
                <div class="collapsible-container">
                    <button class="collapsible"><div class="img-cont"><img src="./_dist_/assets/code-solid.svg"><span>Dev Tools</span></div></button>
                    <div class="content">
                        <span style="font-size: 80%;">Server</span>
                        <hr>
                        <button id='ping'>Send Ping</button>
                        <button id='getusers'>Get Users</button>
                        <button id='createGame'>Make Game session</button>
                        <button id='subscribeToGame'>Subscribe to game session (connect device first)</button>
                        <button id='subscribeToSelf'>Subscribe to self</button>
                    </div>
                </div>
            </div>
            </div>
            <div id="sidebar-toggle"></div>
            <div class="overlay"></div>
        </div>
        </div>
        `;this.uiFragments.Buttons=new y(a,document.body,void 0,()=>{document.getElementById("ping").onclick=()=>{this.bcisession.sendWSCommand(["ping"])},document.getElementById("getusers").onclick=()=>{this.bcisession.sendWSCommand(["getUsers"])},document.getElementById("createGame").onclick=()=>{this.bcisession.sendWSCommand(["createGame",this.bcisession.info.auth.appname,["freeeeg32"],["eegch_FP1","eegch_FP2"]])},document.getElementById("subscribeToGame").onclick=()=>{this.bcisession.subscribeToGame(void 0,!1,i=>{console.log("subscribed!",i)})},document.getElementById("subscribeToSelf").onclick=()=>{this.bcisession.addStreamParam([["eegch","FP1","all"],["eegch","FP2","all"]]),this.bcisession.subscribeToUser("guest",[["eegch","FP1"],["eegch","FP2"]],i=>{console.log("subscribed!",i)})}},void 0,"NEVER");let d=(i=null)=>{Array.from(document.getElementsByClassName("collapsible")).forEach(m=>{let e=m.nextElementSibling;e.style.opacity==="1"&&e!=i&&(e.style.opacity="0",e.style.right="0",e.style.pointerEvents="none")})};var r=document.getElementsByClassName("collapsible"),h;for(h=0;h<r.length;h++)r[h].nextElementSibling.style.opacity="0",r[h].addEventListener("click",function(){this.classList.toggle("active");var i=this.nextElementSibling;i.style.opacity==="0"?(i.style.opacity="1",i.style.right=`-${i.clientWidth}px`,i.style.pointerEvents="auto",d(i)):(i.style.opacity="0",i.style.right="0",i.style.pointerEvents="none")}),r[h].nextElementSibling.addEventListener("mouseleave",function(){this.style.opacity="0",this.style.right="0",this.style.pointerEvents="none"});let g=document.querySelector(".app");g.querySelector("#sidebar").addEventListener("mouseleave",function(i){d()}),document.body.style.overflow="hidden",this.uiFragments.page=new y(x,g);let S=Array.from(g.querySelector("#applet-menu").childNodes).filter(i=>i.className==="content")[0];this.uiFragments.select=new y(A,S);let F=Array.from(g.querySelector("#device-menu").childNodes).filter(i=>i.className==="content")[0];this.bcisession.makeConnectOptions(F);let N=Array.from(g.querySelector("#profile-menu").childNodes).filter(i=>i.className==="content")[0];this.uiFragments.login=new y(U,N),g.querySelector("#login-button").onclick=()=>{let i=g.querySelector("#login-form"),m={},e=new FormData(i);for(var t of e.entries())m[t[0]]=t[1];this.bcisession.setLoginInfo(m.username,m.password),this.bcisession.login(!0)},this.useFS&&(this.uiFragments.filemenu=new y(j,"filecontainer")),this.uiFragments.appletbox=new y(z,document.getElementById("page"),{containerId:"applets",styleInlineText:""})});b(this,"initUI",()=>{this.bcisession.onconnected=()=>{let a=Array.from(app.querySelector("#device-menu").childNodes).filter(d=>d.className==="content")[0];this.uiFragments.controls!==void 0&&this.uiFragments.controls.deleteNode(),this.uiFragments.controls=this.bcisession.devices[this.bcisession.info.nDevices-1].device.addControls(a),this.appletManager.initAddApplets(),this.appletManager.responsive()},this.bcisession.ondisconnected=()=>{},this.setupUITemplates()});b(this,"deinitUI",()=>{this.uiFragments.appletbox.deleteNode(),this.uiFragments.select.deleteNode(),this.uiFragments.filemenu.deleteNode(),this.uiFragments.Buttons.deleteNode()});b(this,"init",(a="")=>{if(a.length>0){let r=JSON.parse(a);r.appletConfigs&&(this.appletConfigs=r.appletConfigs)}let d=this.getConfigsFromHashes();d.length===null&&(this.appletConfigs=d),this.appletManager=new B(this.initUI,this.deinitUI,this.appletClasses,this.appletConfigs,["applet1","applet2","applet3","applet4"],this.bcisession),document.body.querySelector(".app").style.display="block",document.body.querySelector(".loader").style.opacity=0});b(this,"initFS",()=>{let a=n.getRootFS();I.FileSystem.IndexedDB.Create({},(d,r)=>{if(!r){let e=this.getConfigsFromHashes();throw this.appletManager=new B(this.initUI,this.deinitUI,this.appletClasses,e,void 0,this.bcisession),new Error("?")}I.initialize(r),n.exists("/data",e=>{e||n.mkdir("/data");let t="";n.appendFile("/data/settings.json","",l=>{if(l)throw l;n.readFile("/data/settings.json",(s,o)=>{if(s&&(n.mkdir("/data"),n.writeFile("/data/settings.json",JSON.stringify({appletConfigs:this.appletConfigs}),c=>{if(this.init(),c)throw c})),o)t=o.toString(),this.init(t),f();else{let c=JSON.stringify({appletConfigs:[]});t=c,n.writeFile("/data/settings.json",c,p=>{if(p)throw p;console.log("New settings file created"),this.init(t),f()})}this.bcisession.state.data.info=this.bcisession.info,this.bcisession.state.subscribe("info",c=>{if(c.nDevices>0){let p=this.bcisession.devices[c.nDevices-1].info.deviceType;p==="eeg"?(this.bcisession.subscribe(this.bcisession.devices[c.nDevices-1].info.deviceName,this.bcisession.devices[c.nDevices-1].info.eegChannelTags[0].ch,void 0,u=>{this.state.data.saveCounter>u.count&&(this.state.data.saveCounter=this.bcisession.atlas.rolloverLimit-5120),u.count-this.state.data.saveCounter>=this.state.data.saveChunkSize&&(S(),this.state.data.saveCounter=u.count)}),document.getElementById("saveBCISession").onclick=()=>{S()},document.getElementById("newBCISession").onclick=()=>{h()}):p==="heg"&&(this.bcisession.subscribe(this.bcisession.devices[c.nDevices-1].info.deviceName,c.nDevices-1,void 0,u=>{this.state.data.saveCounter>u.count&&(this.state.data.saveCounter=this.bcisession.atlas.rolloverLimit-5120),u.count-this.state.data.saveCounter>=this.state.data.saveChunkSize&&(F(),this.state.data.saveCounter=u.count)}),document.getElementById("saveBCISession").onclick=()=>{F()},document.getElementById("newBCISession").onclick=()=>{h()})}})})})});const h=()=>{let e=this.bcisession.devices[info.nDevices-1].info.deviceType,t=new Date().toISOString();e==="eeg"?t+="_eeg":e==="heg"&&(t+="_heg"),this.state.data.sessionName=t,this.state.data.sessionChunks=0,this.state.data.saveChunkSize=5120,this.state.data.newSessionCt++,n.appendFile("/data/"+t,"",l=>{if(l)throw l;f()})},g=e=>{n.unlink(e,t=>{t&&console.error(t),f()})},f=()=>{n.readdir("/data",(e,t)=>{if(!e&&t){console.log("files",t);let l=document.getElementById("filesystem");l.innerHTML="",t.forEach((s,o)=>{s!=="settings.json"&&(l.innerHTML+=q({id:s}))}),t.forEach((s,o)=>{s!=="settings.json"&&(document.getElementById(s+"svg").onclick=()=>{console.log(s),i(s)},document.getElementById(s+"delete").onclick=()=>{g("/data/"+s)})})}})},S=(e=0,t="end")=>{let l=e;this.state.data.sessionChunks>0&&(l=this.state.data.saveCounter);let s=this.bcisession.devices[0].atlas.readyEEGDataForWriting(l,t);console.log("Saving chunk to /data/"+this.state.data.sessionName,this.state.data.sessionChunks),this.state.data.sessionChunks===0?n.appendFile("/data/"+this.state.data.sessionName,s[0]+s[1],o=>{if(o)throw o;this.state.data.sessionChunks++,f()}):n.appendFile("/data/"+this.state.data.sessionName,`
`+s[1],o=>{if(o)throw o;this.state.data.sessionChunks++})},F=(e=0,t="end")=>{let l=e;this.state.data.sessionChunks>0&&(l=this.state.data.saveCounter);let s=this.bcisession.devices[0].atlas.readyHEGDataForWriting(l,t);console.log("Saving chunk to /data/"+this.state.data.sessionName,this.state.data.sessionChunks),this.state.data.sessionChunks===0?n.appendFile("/data/"+this.state.data.sessionName,s[0]+s[1],o=>{if(o)throw o;this.state.data.sessionChunks++,f()}):n.appendFile("/data/"+this.state.data.sessionName,`
`+s[1],o=>{if(o)throw o;this.state.data.sessionChunks++})},N=(e,t=0,l=5120)=>{n.open("/data/"+e,"r",(s,o)=>{if(s)throw s;n.read(o,l,t,"utf-8",(c,p,u)=>{if(c)throw c;if(u!==0)return p.toString()})})},i=e=>{n.stat("/data/"+e,(t,l)=>{if(t)throw t;let s=l.size;console.log(s),n.open("/data/"+e,"r",(o,c)=>{if(o)throw o;let p=0,u=this.state.data.fileSizeLimitMb*1024*1024,v=u;if(s<u)v=s,n.read(c,v,0,"utf-8",(w,k,E)=>{if(w)throw w;E!==0&&M.saveCSV(k.toString(),e)});else{const w=()=>{if(p<s){p+v>s&&(v=s-p);let k=0;n.read(c,v,p,"utf-8",(E,_,D)=>{if(E)throw E;D!==0&&(M.saveCSV(_.toString(),e+"_"+k),p+=u,k++,w())})}}}})})},m=()=>{n.writeFile("/data/settings.json",JSON.stringify({appletConfigs:this.appletConfigs}),e=>{if(e)throw e})}})});this.state=new G({sessionName:"",saveChunkSize:0,saveChunkSize:5120,saveIdx:0,newSessionCt:0,fileSizeLimitMb:250}),this.uiFragments={controls:void 0},this.bcisession=a,this.appletClasses=d,this.appletConfigs=r,this.appletManager,this.fs,this.useFS=h,this.useFS===!0?this.initFS():this.init()}getConfigsFromHashes(){let a=window.location.hash;if(a==="")return[];let d=a.split("#");a.shift();var r=[];return d.forEach((h,g)=>{var f=JSON.parse(h);r.push(f)}),r}setApps(a=this.appletClasses,d=this.appletConfigs){this.appletClasses=a,this.appletConfigs=d,this.appletManager===null?this.init():(this.appletManager.deinitApplets(),this.appletManager.deinitUI(),this.init())}}
