var T=Object.defineProperty;var b=(y,a,c)=>(typeof a!="symbol"&&(a+=""),a in y?T(y,a,{enumerable:!0,configurable:!0,writable:!0,value:c}):y[a]=c);import{page_template as x,appletbox_template as z,appletselect_template as A,filemenu_template as j,file_template as U,login_template as G}from"./menus/UITemplates.js";import{AppletManager as N}from"./utils/AppletManager.js";import{CSV as M}from"../general/csv.js";import{StateManager as L}from"./utils/StateManager.js";import{DOMFragment as C}from"./utils/DOMFragment.js";import*as I from"../../../_snowpack/pkg/browserfs.js";const n=I.BFSRequire("fs"),q=I.BFSRequire("buffer").Buffer;export class BCIAppManager{constructor(a=null,c=[],r=[],h=!1){b(this,"setupUITemplates",()=>{let a=`
        <div id="sidebar-container">
            <div id="sidebar">
            <div id="sidebar-inner">
                <div class="logo-container">
                    <img class="logo" src="./logo512.png">
                </div>
                <div id="device-menu" class="collapsible-container">
                    <button class="collapsible"><div class="img-cont"><img src="./_dist_/assets/wave-square-solid.svg"><span>Device Manager</span></div></button>
                    <div class="content">
                    </div>
                </div>
                <div id="applet-menu" class="collapsible-container">
                    <button class="collapsible"><div class="img-cont"><img src="./_dist_/assets/th-large-solid.svg"><span>Applets</span></div></button>
                    <div class="content">
                    </div>
                </div>
                <div class="collapsible-container">
                    <button class="collapsible">
                    <div class="img-cont">
                    <img src="./_dist_/assets/folder-solid.svg">
                    <span>File Manager</span>
                    </div>
                    </button>
                    <div id="filecontainer" class="content">
                    <span style="font-size: 80%;">File Manager</span>
                    <hr>
                    </div>
                </div>
                <div id="profile-menu" class="collapsible-container">
                    <button class="collapsible"><div class="img-cont"><img src="./_dist_/assets/user-solid.svg"><span>Profile</span></div></button>
                    <div class="content">
                    <span style="font-size: 80%;">Profile</span>
                    <hr>
                    </div>
                </div>
                <div class="collapsible-container">
                    <button class="collapsible"><div class="img-cont"><img src="./_dist_/assets/code-solid.svg"><span>Dev Tools</span></div></button>
                    <div class="content">
                        <span style="font-size: 80%;">Server</span>
                        <hr>
                        <button id='ping'>Send Ping</button>
                        <button id='getusers'>Get Users</button>
                        <button id='createGame'>Make Game session</button>
                        <button id='subscribeToGame'>Subscribe to game session (connect device first)</button>
                        <button id='subscribeToSelf'>Subscribe to self</button>
                    </div>
                </div>
            </div>
            </div>
            <div id="sidebar-toggle"></div>
            <div class="overlay"></div>
        </div>
        `;this.uiFragments.Buttons=new C(a,document.body,void 0,()=>{document.getElementById("ping").onclick=()=>{this.bcisession.sendWSCommand(["ping"])},document.getElementById("getusers").onclick=()=>{this.bcisession.sendWSCommand(["getUsers"])},document.getElementById("createGame").onclick=()=>{this.bcisession.sendWSCommand(["createGame",this.bcisession.info.auth.appname,["freeeeg32"],["eegch_FP1","eegch_FP2"]])},document.getElementById("subscribeToGame").onclick=()=>{this.bcisession.subscribeToGame(void 0,!1,i=>{console.log("subscribed!",i)})},document.getElementById("subscribeToSelf").onclick=()=>{this.bcisession.addStreamParam([["eegch","FP1","all"],["eegch","FP2","all"]]),this.bcisession.subscribeToUser("guest",[["eegch","FP1"],["eegch","FP2"]],i=>{console.log("subscribed!",i)})}},void 0,"NEVER");let c=(i=null)=>{Array.from(document.getElementsByClassName("collapsible")).forEach(f=>{let u=f.nextElementSibling;u.style.opacity==="1"&&u!=i&&(u.style.opacity="0",u.style.right="0",u.style.pointerEvents="none")})};var r=document.getElementsByClassName("collapsible"),h;for(h=0;h<r.length;h++)r[h].nextElementSibling.style.opacity="0",r[h].addEventListener("click",function(){this.classList.toggle("active");var i=this.nextElementSibling;i.style.opacity==="0"?(i.style.opacity="1",i.style.right=`-${i.clientWidth}px`,i.style.pointerEvents="auto",c(i)):(i.style.opacity="0",i.style.right="0",i.style.pointerEvents="none")}),r[h].nextElementSibling.addEventListener("mouseleave",function(){this.style.opacity="0",this.style.right="0",this.style.pointerEvents="none"});document.getElementById("sidebar").addEventListener("mouseleave",function(i){c()}),document.body.style.overflow="hidden",this.uiFragments.page=new C(x,document.body);let m=Array.from(document.getElementById("applet-menu").childNodes).filter(i=>i.className==="content")[0];this.uiFragments.select=new C(A,m);let S=Array.from(document.getElementById("device-menu").childNodes).filter(i=>i.className==="content")[0];this.bcisession.makeConnectOptions(S);let F=Array.from(document.getElementById("profile-menu").childNodes).filter(i=>i.className==="content")[0];this.uiFragments.login=new C(G,F),document.getElementById("login-button").onclick=()=>{let i=document.getElementById("login-form"),f={},u=new FormData(i);for(var t of u.entries())f[t[0]]=t[1];this.bcisession.setLoginInfo(f.username,f.password),this.bcisession.login(!0)},this.useFS&&(this.uiFragments.filemenu=new C(j,"filecontainer")),this.uiFragments.appletbox=new C(z,document.getElementById("page"),{containerId:"applets",styleInlineText:""})});b(this,"initUI",()=>{this.bcisession.onconnected=()=>{let a=Array.from(document.getElementById("device-menu").childNodes).filter(c=>c.className==="content")[0];this.uiFragments.controls!==void 0&&this.uiFragments.controls.deleteNode(),this.uiFragments.controls=this.bcisession.devices[this.bcisession.info.nDevices-1].device.addControls(a),this.appletManager.initAddApplets(),this.appletManager.responsive()},this.bcisession.ondisconnected=()=>{},this.setupUITemplates()});b(this,"deinitUI",()=>{this.uiFragments.appletbox.deleteNode(),this.uiFragments.select.deleteNode(),this.uiFragments.filemenu.deleteNode(),this.uiFragments.Buttons.deleteNode()});b(this,"init",(a="")=>{if(a.length>0){let r=JSON.parse(a);r.appletConfigs&&(this.appletConfigs=r.appletConfigs)}let c=this.getConfigsFromHashes();c.length===null&&(this.appletConfigs=c),this.appletManager=new N(this.initUI,this.deinitUI,this.appletClasses,this.appletConfigs,["applet1","applet2","applet3","applet4"],this.bcisession)});b(this,"initFS",()=>{let a=n.getRootFS();I.FileSystem.IndexedDB.Create({},(c,r)=>{if(!r){let t=this.getConfigsFromHashes();throw this.appletManager=new N(this.initUI,this.deinitUI,this.appletClasses,t,void 0,this.bcisession),new Error("?")}I.initialize(r),n.exists("/data",t=>{t||n.mkdir("/data");let s="";n.appendFile("/data/settings.json","",l=>{if(l)throw l;n.readFile("/data/settings.json",(e,o)=>{if(e&&(n.mkdir("/data"),n.writeFile("/data/settings.json",JSON.stringify({appletConfigs:this.appletConfigs}),d=>{if(this.init(),d)throw d})),o)s=o.toString(),this.init(s),m();else{let d=JSON.stringify({appletConfigs:[]});s=d,n.writeFile("/data/settings.json",d,p=>{if(p)throw p;console.log("New settings file created"),this.init(s),m()})}this.bcisession.state.data.info=this.bcisession.info,this.bcisession.state.subscribe("info",d=>{if(d.nDevices>0){let p=this.bcisession.devices[d.nDevices-1].info.deviceType;p==="eeg"?(this.bcisession.subscribe(this.bcisession.devices[d.nDevices-1].info.deviceName,this.bcisession.devices[d.nDevices-1].info.eegChannelTags[0].ch,void 0,g=>{this.state.data.saveCounter>g.count&&(this.state.data.saveCounter=this.bcisession.atlas.rolloverLimit-5120),g.count-this.state.data.saveCounter>=this.state.data.saveChunkSize&&(S(),this.state.data.saveCounter=g.count)}),document.getElementById("saveBCISession").onclick=()=>{S()},document.getElementById("newBCISession").onclick=()=>{h()}):p==="heg"&&(this.bcisession.subscribe(this.bcisession.devices[d.nDevices-1].info.deviceName,d.nDevices-1,void 0,g=>{this.state.data.saveCounter>g.count&&(this.state.data.saveCounter=this.bcisession.atlas.rolloverLimit-5120),g.count-this.state.data.saveCounter>=this.state.data.saveChunkSize&&(F(),this.state.data.saveCounter=g.count)}),document.getElementById("saveBCISession").onclick=()=>{F()},document.getElementById("newBCISession").onclick=()=>{h()})}})})})});const h=()=>{let t=this.bcisession.devices[info.nDevices-1].info.deviceType,s=new Date().toISOString();t==="eeg"?s+="_eeg":t==="heg"&&(s+="_heg"),this.state.data.sessionName=s,this.state.data.sessionChunks=0,this.state.data.saveChunkSize=5120,this.state.data.newSessionCt++,n.appendFile("/data/"+s,"",l=>{if(l)throw l;m()})},B=t=>{n.unlink(t,s=>{s&&console.error(s),m()})},m=()=>{n.readdir("/data",(t,s)=>{if(!t&&s){console.log("files",s);let l=document.getElementById("filesystem");l.innerHTML="",s.forEach((e,o)=>{e!=="settings.json"&&(l.innerHTML+=U({id:e}))}),s.forEach((e,o)=>{e!=="settings.json"&&(document.getElementById(e+"svg").onclick=()=>{console.log(e),f(e)},document.getElementById(e+"delete").onclick=()=>{B("/data/"+e)})})}})},S=(t=0,s="end")=>{let l=t;this.state.data.sessionChunks>0&&(l=this.state.data.saveCounter);let e=this.bcisession.devices[0].atlas.readyEEGDataForWriting(l,s);console.log("Saving chunk to /data/"+this.state.data.sessionName,this.state.data.sessionChunks),this.state.data.sessionChunks===0?n.appendFile("/data/"+this.state.data.sessionName,e[0]+e[1],o=>{if(o)throw o;this.state.data.sessionChunks++,m()}):n.appendFile("/data/"+this.state.data.sessionName,`
`+e[1],o=>{if(o)throw o;this.state.data.sessionChunks++})},F=(t=0,s="end")=>{let l=t;this.state.data.sessionChunks>0&&(l=this.state.data.saveCounter);let e=this.bcisession.devices[0].atlas.readyHEGDataForWriting(l,s);console.log("Saving chunk to /data/"+this.state.data.sessionName,this.state.data.sessionChunks),this.state.data.sessionChunks===0?n.appendFile("/data/"+this.state.data.sessionName,e[0]+e[1],o=>{if(o)throw o;this.state.data.sessionChunks++,m()}):n.appendFile("/data/"+this.state.data.sessionName,`
`+e[1],o=>{if(o)throw o;this.state.data.sessionChunks++})},i=(t,s=0,l=5120)=>{n.open("/data/"+t,"r",(e,o)=>{if(e)throw e;n.read(o,l,s,"utf-8",(d,p,g)=>{if(d)throw d;if(g!==0)return p.toString()})})},f=t=>{n.stat("/data/"+t,(s,l)=>{if(s)throw s;let e=l.size;console.log(e),n.open("/data/"+t,"r",(o,d)=>{if(o)throw o;let p=0,g=this.state.data.fileSizeLimitMb*1024*1024,v=g;if(e<g)v=e,n.read(d,v,0,"utf-8",(E,w,k)=>{if(E)throw E;k!==0&&M.saveCSV(w.toString(),t)});else{const E=()=>{if(p<e){p+v>e&&(v=e-p);let w=0;n.read(d,v,p,"utf-8",(k,_,D)=>{if(k)throw k;D!==0&&(M.saveCSV(_.toString(),t+"_"+w),p+=g,w++,E())})}}}})})},u=()=>{n.writeFile("/data/settings.json",JSON.stringify({appletConfigs:this.appletConfigs}),t=>{if(t)throw t})}})});this.state=new L({sessionName:"",saveChunkSize:0,saveChunkSize:5120,saveIdx:0,newSessionCt:0,fileSizeLimitMb:250}),this.uiFragments={controls:void 0},this.bcisession=a,this.appletClasses=c,this.appletConfigs=r,this.appletManager,this.fs,this.useFS=h,this.useFS===!0?this.initFS():this.init()}getConfigsFromHashes(){let a=window.location.hash;if(a==="")return[];let c=a.split("#");a.shift();var r=[];return c.forEach((h,B)=>{var m=JSON.parse(h);r.push(m)}),r}setApps(a=this.appletClasses,c=this.appletConfigs){this.appletClasses=a,this.appletConfigs=c,this.appletManager===null?this.init():(this.appletManager.deinitApplets(),this.appletManager.deinitUI(),this.init())}}
