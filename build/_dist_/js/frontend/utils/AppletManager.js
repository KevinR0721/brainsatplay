var h=Object.defineProperty;var p=(d,e,i)=>(typeof e!="symbol"&&(e+=""),e in d?h(d,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):d[e]=i);import{brainsatplay as f}from"../../brainsatplay.js";import"./DOMFragment.js";export class AppletManager{constructor(e=()=>{},i=()=>{},t=[],l=[],n=["applet1","applet2","applet3","applet4"],s=new f){p(this,"initUI",()=>{});p(this,"deinitUI",()=>{});p(this,"checkCompatibility",(e,i=this.bcisession.devices)=>{let t=!1;return this.bcisession.devices.length===0?t=!0:this.bcisession.devices.forEach(l=>{Array.isArray(e.devices)?(e.devices.includes(l.info.deviceType)||e.devices.includes(l.info.deviceName))&&(t=!0):typeof e.devices=="object"&&(e.devices.includes(l.info.devices.deviceType)||e.devices.devices.includes(l.info.deviceName))&&e.devices.eegChannelTags&&e.devices.eegChannelTags.forEach((n,s)=>{o.atlas.eegshared.eegChannelTags.find(r=>{if(r.tag===n)return!0})&&(t=!0)})}),t});p(this,"initAddApplets",(e=[])=>{let i;e.length!==0&&e.forEach((n,s)=>{this.appletClasses.find((a,r)=>{n.name===a.name&&(i=n.settings)})});let t=this.applets.map(n=>n.name),l=this.appletClasses.filter(n=>{let s=!1;if(!t.includes(n.name)&&(s=this.checkCompatibility(n.cls),s||this.bcisession.devices.length===0))return n});t.forEach((n,s)=>{let a=this.appletClasses.filter(c=>c.name==n)[0],r=!1;if(a!=null&&(r=this.checkCompatibility(a.cls)),!r){this.applets[s].classinstance!=null&&this.deinitApplet(this.applets[s].appletIdx);let c=l[0];this.applets[s]={appletIdx:s+1,name:c.name,classinstance:new c.cls("applets",this.bcisession,i)},l.splice(0,1)}this.appletsSpawned++}),this.initApplets(),this.appletSelectIds.forEach((n,s)=>{this.addAppletOptions(n,s)})});p(this,"appletDivSettings",(e,i)=>{e.style.gridArea=String.fromCharCode(97+i),e.style.overflow="hidden",e.addEventListener("dblclick",()=>{document.fullscreenElement||document.webkitFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen()})});p(this,"initApplets",()=>{this.applets.forEach((e,i)=>{if(e.classinstance!=null){e.classinstance.AppletHTML===null&&e.classinstance.init();let t=e.classinstance.AppletHTML.node;t.style.gridArea=String.fromCharCode(97+i),t.style.overflow="hidden",t.name=e.name,t.addEventListener("dragstart",()=>{t.classList.add("dragging")}),t.addEventListener("dragend",()=>{t.classList.remove("dragging")}),t.addEventListener("dragover",l=>{l.preventDefault(),t.classList.add("hovered")}),t.addEventListener("dragleave",l=>{l.preventDefault(),t.classList.remove("hovered")}),t.addEventListener("drop",function(l){l.preventDefault();let n=document.querySelector(".dragging");t.classList.remove("hovered")},!1),t.addEventListener("dblclick",()=>{document.fullscreenElement||document.webkitFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen()})}}),this.responsive()});p(this,"addApplet",(e,i,t=void 0)=>{if(this.appletsSpawned<this.maxApplets){var l=this.appletClasses[e],n=this.applets.find((r,c)=>{if(r.appletIdx===i)return this.deinitApplet(i),!0}),s=i-1;s>this.applets.length?(s=this.applets.length,this.applets[s]={appletIdx:s+1,name:l.name,classinstance:new l.cls("applets",this.bcisession,t)}):this.applets[s]={appletIdx:s+1,name:l.name,classinstance:new l.cls("applets",this.bcisession,t)},this.applets[s].classinstance.init();let a=this.applets[s].classinstance.AppletHTML.node;this.appletDivSettings(a,s),this.appletsSpawned++,this.responsive(),console.log("applet added")}});p(this,"deinitApplet",e=>{var i=null,t=this.applets.find((l,n)=>{if(l.appletIdx===e)return i=n,this.applets[i].classinstance!=null&&this.applets[i].classinstance.deinit(),this.applets[i]={appletIdx:i+1,name:null,classinstance:null},this.appletsSpawned--,this.responsive(),!0})});p(this,"reinitApplets",()=>{this.applets.forEach((e,i)=>{e.classinstance.deinit(),e.classinstance.init()}),this.responsive()});p(this,"addAppletOptions",(e,i)=>{var t=document.getElementById(e);t.innerHTML="";var l=`<option value='None' selected="selected">None</option>`;this.appletClasses.forEach((n,s)=>{this.checkCompatibility(n.cls)&&(this.applets[i]&&this.applets[i].name===n.name?l+="<option value='"+n.name+`' selected="selected">`+this.appletClasses[s].name+"</option>":l+="<option value='"+n.name+"'>"+this.appletClasses[s].name+"</option>")}),t.innerHTML=l,t.addEventListener("change",()=>{if(this.deinitApplet(i+1),t.value!=="None"){let n=this.appletClasses.find((s,a)=>{if(s.name===t.value)return this.addApplet(a,i+1),!0})}})});this.initUI=e,this.deinitUI=i,this.initUI(),this.appletClasses=t,this.appletsSpawned=0,this.maxApplets=4,this.applets=Array.from({length:this.maxApplets},(r,c)=>({appletIdx:c+1,name:null,classinstance:null})),this.bcisession=s,this.appletSelectIds=n,this.initAddApplets(l),window.addEventListener("resize",()=>{this.responsive()});let a=document.getElementById("applets");a.style.display="grid",a.style.height="calc(100vh)",a.style.width="calc(100vw - 75px)"}deinitApplets(){this.applets.forEach((e,i)=>{this.deinitApplet(i)})}responsive(e=this.applets){let i=e.filter(s=>s.classinstance!=null),t=Math.ceil(Math.sqrt(e.length)),l=Array.from({length:t},s=>[]);e.forEach((s,a,r)=>{s.classinstance!=null&&(i.length>1?s.classinstance!=null?l[Math.floor(a/Math.ceil(Math.sqrt(r.length)))].push(String.fromCharCode(97+a)):Math.floor(a/t)==Math.floor((a+1)/t)?l[Math.floor(a/t)].push(String.fromCharCode(97+(a+1))):Math.floor(a/t)==Math.floor((a-1)/t)&&l[Math.floor(a/t)].push(String.fromCharCode(97+(a-1))):l[Math.floor(a/t)].push(String.fromCharCode(97+(i[0].appletIdx-1))))}),l=l.map(s=>'"'+s.join(" ")+'"').join(" ");let n=document.getElementById("applets");n.style.gridTemplateAreas=l,n.style.gridTemplateColumns=`repeat(${t},1fr)`,n.style.gridTemplateRows=`repeat(${t},1fr)`,i.forEach((s,a)=>{let r=s.classinstance.AppletHTML.node,c=100/Math.ceil(Math.sqrt(e.length));e.length===1?r.style.maxHeight=`calc(${100}vh)`:e.length===2?r.style.maxHeight=`calc(${50}vh)`:r.style.maxHeight=`calc(${c}vh)`}),i.forEach((s,a)=>{s.classinstance.responsive()})}}
