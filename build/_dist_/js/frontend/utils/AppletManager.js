var h=Object.defineProperty;var c=(d,t,s)=>(typeof t!="symbol"&&(t+=""),t in d?h(d,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):d[t]=s);import{brainsatplay as f}from"../../brainsatplay.js";import"./DOMFragment.js";export class AppletManager{constructor(t=()=>{},s=()=>{},e=[],l=[],n=["applet1","applet2","applet3","applet4"],i=new f){c(this,"initUI",()=>{});c(this,"deinitUI",()=>{});c(this,"checkCompatibility",(t,s=this.bcisession.devices)=>{let e=!1;return this.bcisession.devices.length===0?e=!0:this.bcisession.devices.forEach(l=>{Array.isArray(t.devices)?(t.devices.includes(l.info.deviceType)||t.devices.includes(l.info.deviceName))&&(e=!0):typeof t.devices=="object"&&(t.devices.includes(l.info.devices.deviceType)||t.devices.devices.includes(l.info.deviceName))&&t.devices.eegChannelTags&&t.devices.eegChannelTags.forEach((n,i)=>{o.atlas.eegshared.eegChannelTags.find(p=>{if(p.tag===n)return!0})&&(e=!0)})}),e});c(this,"initAddApplets",(t=[])=>{let s;t.length!==0&&t.forEach((n,i)=>{this.appletClasses.find((a,p)=>{n.name===a.name&&(s=n.settings)})});let e=this.applets.map(n=>n.name),l=this.appletClasses.filter(n=>{let i=!1;if(!e.includes(n.name)&&(i=this.checkCompatibility(n.cls),i||this.bcisession.devices.length===0))return n});e.forEach((n,i)=>{let a=this.appletClasses.filter(r=>r.name==n)[0],p=!1;if(a!=null&&(p=this.checkCompatibility(a.cls)),!p){this.applets[i].classinstance!=null&&this.deinitApplet(this.applets[i].appletIdx);let r=l[0];this.applets[i]={appletIdx:i+1,name:r.name,classinstance:new r.cls("applets",this.bcisession,s)},l.splice(0,1)}this.appletsSpawned++}),this.initApplets(),this.appletSelectIds.forEach((n,i)=>{this.addAppletOptions(n,i)})});c(this,"appletDivSettings",(t,s)=>{t.style.gridArea=String.fromCharCode(97+s),t.style.overflow="hidden",t.addEventListener("dblclick",()=>{document.fullscreenElement||document.webkitFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen()})});c(this,"initApplets",()=>{this.applets.forEach((t,s)=>{if(t.classinstance!=null){t.classinstance.AppletHTML===null&&t.classinstance.init();let e=t.classinstance.AppletHTML.node;e.style.gridArea=String.fromCharCode(97+s),e.style.overflow="hidden",e.name=t.name,e.addEventListener("dragstart",()=>{e.classList.add("dragging")}),e.addEventListener("dragend",()=>{e.classList.remove("dragging")}),e.addEventListener("dragover",l=>{l.preventDefault(),e.classList.add("hovered")}),e.addEventListener("dragleave",l=>{l.preventDefault(),e.classList.remove("hovered")}),e.addEventListener("drop",function(l){l.preventDefault();let n=document.querySelector(".dragging");e.classList.remove("hovered")},!1),e.addEventListener("dblclick",()=>{document.fullscreenElement||document.webkitFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen()})}}),this.responsive()});c(this,"addApplet",(t,s,e=void 0)=>{if(this.appletsSpawned<this.maxApplets){var l=this.appletClasses[t],n=this.applets.find((p,r)=>{if(p.appletIdx===s)return this.deinitApplet(s),!0}),i=s-1;i>this.applets.length?(i=this.applets.length,this.applets[i]={appletIdx:i+1,name:l.name,classinstance:new l.cls("applets",this.bcisession,e)}):this.applets[i]={appletIdx:i+1,name:l.name,classinstance:new l.cls("applets",this.bcisession,e)},this.applets[i].classinstance.init();let a=this.applets[i].classinstance.AppletHTML.node;this.appletDivSettings(a,i),this.appletsSpawned++,this.responsive(),console.log("applet added"),this.appletSelectIds.forEach((p,r)=>{this.addAppletOptions(p,r)})}});c(this,"deinitApplet",t=>{var s=null,e=this.applets.find((l,n)=>{if(l.appletIdx===t)return s=n,this.applets[s].classinstance!=null&&this.applets[s].classinstance.deinit(),this.applets[s]={appletIdx:s+1,name:null,classinstance:null},this.appletsSpawned--,this.responsive(),!0})});c(this,"reinitApplets",()=>{this.applets.forEach((t,s)=>{t.classinstance.deinit(),t.classinstance.init()}),this.responsive()});c(this,"addAppletOptions",(t,s)=>{var e=document.getElementById(t);e.innerHTML="";var l=`<option value='None' selected="selected">None</option>`;this.appletClasses.forEach((n,i)=>{this.checkCompatibility(n.cls)&&(this.applets[s]&&this.applets[s].name===n.name?l+="<option value='"+n.name+`' selected="selected">`+this.appletClasses[i].name+"</option>":l+="<option value='"+n.name+"'>"+this.appletClasses[i].name+"</option>")}),e.innerHTML=l,e.addEventListener("change",()=>{if(this.deinitApplet(s+1),e.value!=="None"){let n=this.appletClasses.find((i,a)=>{if(i.name===e.value)return this.addApplet(a,s+1),!0})}})});this.initUI=t,this.deinitUI=s,this.initUI(),this.appletClasses=e,this.appletsSpawned=0,this.maxApplets=4,this.applets=Array.from({length:this.maxApplets},(p,r)=>({appletIdx:r+1,name:null,classinstance:null})),this.bcisession=i,this.appletSelectIds=n,this.initAddApplets(l),window.addEventListener("resize",()=>{this.responsive()});let a=document.getElementById("applets");a.style.display="grid",a.style.height="calc(100vh)",a.style.width="calc(100vw - 75px)"}deinitApplets(){this.applets.forEach((t,s)=>{this.deinitApplet(s)})}responsive(t=this.applets){console.log("responding");let s=t.filter(i=>i.classinstance!=null),e=Math.ceil(Math.sqrt(t.length)),l=Array.from({length:e},i=>[]);t.forEach((i,a,p)=>{s.length>1?i.classinstance!=null?l[Math.floor(a/Math.ceil(Math.sqrt(p.length)))].push(String.fromCharCode(97+a)):Math.floor(a/e)==Math.floor((a+1)/e)?l[Math.floor(a/e)].push(String.fromCharCode(97+(a+1))):Math.floor(a/e)==Math.floor((a-1)/e)&&l[Math.floor(a/e)].push(String.fromCharCode(97+(a-1))):s.length>0&&l[Math.floor(a/e)].push(String.fromCharCode(97+(s[0].appletIdx-1)))}),l=l.map(i=>'"'+i.join(" ")+'"').join(" ");let n=document.getElementById("applets");n.style.gridTemplateAreas=l,n.style.gridTemplateColumns=`repeat(${e},1fr)`,n.style.gridTemplateRows=`repeat(${e},1fr)`,s.forEach((i,a)=>{let p=i.classinstance.AppletHTML.node,r=100/Math.ceil(Math.sqrt(s.length));s.length===1?p.style.maxHeight=`calc(${100}vh)`:s.length===2?p.style.maxHeight=`calc(${50}vh)`:p.style.maxHeight=`calc(${r}vh)`}),s.forEach((i,a)=>{i.classinstance.responsive()})}}
