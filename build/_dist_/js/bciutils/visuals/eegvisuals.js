var N=Object.defineProperty;var v=(g,t,e)=>(typeof t!="symbol"&&(t+=""),t in g?N(g,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):g[t]=e);import I from"../../../../_snowpack/pkg/uplot.js";import{SmoothieChart as k,TimeSeries as j}from"../../../../_snowpack/pkg/smoothie.js";import"./webgl-heatmap.js";export class SmoothieChartMaker{constructor(t=1,e=null){if(typeof k=="undefined")return alert("smoothie.js not found!"),!1;this.canvas=e,this.canvasId=e.id,this.series=[],this.seriesColors=[],this.chart=null;for(var l=0;l<t;l++){var a=new j;this.series.push(a)}}deInit(){this.chart.stop();var t=this.canvas.getContext("2d");t.clearRect(0,0,this.canvas.width,this.canvas.height)}init(t="rgb(125, 125, 125)",e="rgb(10, 10, 10)",l="rgb(255, 255, 255)"){this.makeSmoothieChart(this.canvas,t,e,l)}makeSmoothieChart(t=this.canvas,e="rgb(125, 125, 125)",l="rgb(10, 10, 10)",a="rgb(255, 255, 255)"){this.chart=new k({responsive:!0,grid:{strokeStyle:e,fillStyle:l,lineWidth:1,millisPerLine:500,verticalSections:6},labels:{fillStyle:a}}),this.series.forEach((s,c)=>{var i="",h="";if(c===0)i="red",h="rgba(255,0,0,0.2)";else if(c===1)i="orange",h="rgba(255,128,0,0.2)";else if(c===2)i="green",h="rgba(0,255,0,0.2)";else if(c===3)i="turquoise",h="rgba(0,255,150,0.2)";else if(c===4)i="rgba(50,50,255,1)",h="rgba(0,0,255,0.2)";else if(c===5)i="rgba(200,0,200,1)",h="rgba(128,0,128,0.2)";else{var r=Math.random()*255,n=Math.random()*255,f=Math.random()*255;i="rgb("+r+","+n+","+f+")",h="rgba("+r+","+n+","+f+",0.2)"}this.seriesColors.push(i),this.chart.addTimeSeries(s,{strokeStyle:i,fillStyle:h,lineWidth:2})}),t!==null&&this.chart.streamTo(t,500)}streamTo(t=this.canvas){t!==null?this.chart.streamTo(t,500):console.log("Needs a canvas id to stream the chart to")}bulkAppend(t=[.5]){var e=Date.now();t.forEach((l,a)=>{this.series[a].append(e,l)})}}export class uPlotMaker{constructor(t=null){v(this,"makeStackeduPlot",(t=[{}],e=[],l=null,a=null,s=1e3,c=800,i=!0)=>{var h=[{}],r=0;if(t===h){if(a===null){console.log("No series data!");return}r=a.length}var n,f=[],o=[],m=[],x=e;if(x.length===0){console.log("No data inputted!");return}x.forEach((d,b)=>{b>0&&(f.push(Math.ceil(Math.max(...d))-Math.min(...d)),m.push(Math.min(...d)),o.push(Math.max(...d)))});var y=Math.max(...f),M=0,D=(d,b)=>{for(var u=0,p=0;u<M;)p+=1,u++;return m[M]<0&&(p+=Math.abs(m[u])/y),d/y+p},F=[x[0]];x.forEach((d,b)=>{b>0&&(F.push(d.map((u,p)=>D(u,p))),M++)});var z=1;a!==null?a.forEach((d,b)=>{var u=Math.random()*128,p=Math.random()*128,P=Math.random()*128,T="rgb("+u+","+p+","+P+")",B="rgba("+u+","+p+","+P+",0.1)",R=(W,A,H,q)=>A===null?"-":x[H-1][q].toFixed(2);h.push({label:"A"+d.ch+", Tag: "+d.tag,stroke:T,value:R,fill:B,fillTo:(W,A)=>A-1}),z++}):h=t,n=(d,b)=>b.map((u,p)=>E(u,p));var C=-1,E=(d,b)=>{if(d===Math.floor(d)){if(d<h.length)return C++,h[d].label}else return((d-C)*y+m[C]).toFixed(2)};let w={auto:!0};i===!0||(w={auto:!1,range:i});var S;l===null?S={width:s,height:c,series:h,legend:{show:!1},scales:{x:{time:!1},y:w},axes:[{scale:"sec",values:(d,b,u)=>b.map(p=>+p.toFixed(2)+"s")},{size:80,values:n}]}:S=l,this.plot!==null&&this.plot.destroy(),this.plot=new I(S,F,document.getElementById(this.plotId))});if(I==="undefined")return console.log("uPlot not detected!"),!1;this.plotId=t,this.plot=null,this.uPlotData=[]}deInit(){this.plot!==null&&(this.plot.destroy(),this.plot=null)}init(){}makeuPlot(t=[{}],e=[],l=1e3,a=400,s=null,c=!0){if(t.length<2)return console.log("Input valid series"),!1;var i={};let h={auto:!0};c===!0||(h={auto:!1,range:c}),s===null?i={width:l,height:a,series:t,legend:{show:!1},scales:{x:{time:!1},y:h},axes:[{scale:"Hz",values:(n,f,o)=>f.map(m=>+m.toFixed(2)+"Hz")}]}:i=s;var r=e;if(r.length<t.length-1)for(;r.length<t.length-1;)r.length>0?r.push([new Array(r[0].length).fill(Math.random())]):r.push([new Array(100).fill(0)]);else r.length>t.length&&r.splice(t.length,r.length-t.length);this.plot!==null&&this.plot.destroy(),this.plot=new I(i,r,document.getElementById(this.plotId))}makeSeriesFromChannelTags(t,e=!0,l=null){var a=[{}];return t.forEach((s,c)=>{e===!0?s.tag!==null&&s.tag!=="other"&&(l===null||s.ch===l)&&a.push({label:"A"+s.ch+", Tag: "+s.tag,value:(i,h)=>h==null?"-":h.toFixed(2),stroke:"rgb("+Math.random()*128+","+Math.random()*128+","+Math.random()*128+")"}):(l===null||s.ch===l)&&a.push({label:"A"+s.ch+", Tag: "+s.tag,value:(i,h)=>h==null?"-":h.toFixed(2),stroke:"rgb("+Math.random()*128+","+Math.random()*128+","+Math.random()*128+")"})}),a}updateData(t){this.plot.setData(t)}updateStackedData(t,e=!1){var l=[],a=[],s=[];if(t.length===0){console.error("uPlotMaker: No data inputted!");return}t.forEach((n,f)=>{f>0&&(l.push(Math.ceil(Math.max(...n))-Math.min(...n)),s.push(Math.min(...n)),a.push(Math.max(...n)))});var c=Math.max(...l),i=0,h=(n,f)=>{for(var o=0,m=0;o<i;)m+=1,o++;return s[i]<0&&(m+=Math.abs(s[o])/c),n/c+m},r=[t[0]];if(t.forEach((n,f)=>{f>0&&(r.push(n.map((o,m)=>h(o,m))),i++)}),e){let n=-1;const f=(m,x)=>{if(m===Math.floor(m)){if(m<this.plot.series.length)return n++,this.plot.series[m].label}else return((m-n)*c+s[n]).toFixed(2)};let o=(m,x)=>x.map((y,M)=>f(y,M));this.plot.axes[1].values=o}this.plot.setData(r)}}export class BrainMap2D{constructor(t=null,e=null){v(this,"draw",()=>{this.heatmap.clear(),this.heatmap.addPoints(this.points),this.heatmap.update(),this.heatmap.display()});v(this,"animate",()=>{this.draw(),setTimeout(()=>{this.anim!=="cancel"&&(this.anim=requestAnimationFrame(animate))},this.animationDelay)});if(typeof createWebGLHeatmap=="undefined")return console.log("webgl-heatmap.js not found! Please include in your app correctly"),!1;this.heatmapCanvasId=t,this.pointsCanvasId=e,this.anim=null,this.animationDelay=20,this.heatmap=null,this.pointsCanvas=null,this.pointsCtx=null,t!==null&&e!==null&&(this.heatmap=createWebGLHeatmap({canvas:document.getElementById(this.heatmapCanvasId),intensityToAlpha:!0}),this.pointsCanvas=document.getElementById(this.pointsCanvasId),this.pointsCtx=this.pointsCanvas.getContext("2d")),this.points=[{x:100,y:100,size:100,intensity:.7}],this.scale=1.5}deInit(){this.anim="cancel",cancelAnimationFrame(this.anim),this.heatmap.clear()}init(){this.anim=requestAnimationFrame(draw)}genHeatMap(t=this.heatmapCanvasId,e=this.pointsCanvasId){this.heatmap=createWebGLHeatmap({canvas:document.getElementById(t),intensityToAlpha:!0}),this.pointsCanvas=document.getElementById(e),this.pointsCanvas.width=this.heatmap.width,this.pointsCanvas.height=this.heatmap.height,this.pointsCtx=this.pointsCanvas.getContext("2d")}updateHeatmap(t=this.points){this.heatmap.clear(),this.heatmap.addPoints(t),this.heatmap.update(),this.heatmap.display()}updateHeatmapFromAtlas(t,e,l,a=1){var s=[],c=this.pointsCanvas.width*.5,i=this.pointsCanvas.height*.5,h=1/a;e.forEach((r,n)=>{let f=t.find((o,m)=>{o.tag===r.tag&&(s.push({x:o.position.x*this.scale+c,y:i-o.position.y*this.scale,size:10,intensity:.7}),l==="scp"?s[n].size=Math.max(...o.slices.scp[o.slices.scp.length-1]):l==="delta"?s[n].size=Math.max(...o.slices.delta[o.slices.delta.length-1]):l==="theta"?s[n].size=Math.max(...o.slices.theta[o.slices.theta.length-1]):l==="alpha1"?s[n].size=Math.max(...o.slices.alpha1[o.slices.alpha1.length-1]):l==="alpha2"?s[n].size=Math.max(...o.slices.alpha2[o.slices.alpha2.length-1]):l==="beta"?s[n].size=Math.max(...o.slices.beta[o.slices.beta.length-1]):l==="lowgamma"?s[n].size=Math.max(...o.slices.lowgamma[o.slices.lowgamma.length-1]):l==="highgamma"&&(s[n].size=Math.max(...o.slices.highgamma[o.slices.highgamma.length-1])),s[n].size*=h,s[n].size>90*this.scale&&(s[n].size=90*this.scale))})}),this.points=s,this.heatmap.clear(),this.heatmap.addPoints(this.points),this.heatmap.update(),this.heatmap.display()}updatePointsFromAtlas(t,e,l=!0){var a=this.pointsCanvas.width*.5,s=this.pointsCanvas.height*.5;l===!0&&(this.pointsCtx.fillStyle="rgba(0,0,0,0)",this.pointsCtx.clearRect(0,0,this.pointsCanvas.width,this.pointsCanvas.height)),t.forEach((c,i)=>{this.pointsCtx.beginPath(),this.pointsCtx.fillStyle="rgba(0,0,255,1)";let h=e.find((r,n)=>{if(r.tag===c.tag)return this.pointsCtx.fillStyle="rgba(0,0,0,0.7)",this.pointsCtx.fillText(r.ch,a-15+c.position.x*this.scale,s+10-c.position.y*this.scale,14),this.pointsCtx.fillStyle="rgba(0,255,0,1)",!0});this.pointsCtx.arc(a+c.position.x*this.scale,s-c.position.y*this.scale,4,0,Math.PI*2,!0),this.pointsCtx.closePath(),this.pointsCtx.fill(),this.pointsCtx.fillStyle="rgba(0,0,0,0.7)",this.pointsCtx.fillText(c.tag,a+4+c.position.x*this.scale,s+10-c.position.y*this.scale,14)})}updateConnectomeFromAtlas(t,e,l,a,s=!0,c=.01){var i=this.pointsCanvas.width*.5,h=this.pointsCanvas.height*.5,r=this.pointsCtx;s===!0&&(r.fillStyle="rgba(0,0,0,0)",r.clearRect(0,0,this.pointsCanvas.width,this.pointsCanvas.height));var n="";a==="scp"?n="rgba(0,0,0,":a==="delta"?n="rgba(255,0,0,":a==="theta"?n="rgba(0,255,200,":a==="alpha1"?n="rgba(0,100,255,":a==="alpha2"?n="rgba(0,200,255,":a==="beta"?n="rgba(255,0,255,":(a==="lowgamma"||a==="highgamma")&&(n="rgba(255,255,0,"),t.forEach((f,o)=>{a==="scp"?r.strokeStyle=n+Math.max(...f.slices.scp[f.slices.scp.length-1])*c+")":a==="delta"?r.strokeStyle=n+Math.max(...f.slices.delta[f.slices.delta.length-1])*c+")":a==="theta"?r.strokeStyle=n+Math.max(...f.slices.theta[f.slices.theta.length-1])*c+")":a==="alpha1"?r.strokeStyle=n+Math.max(...f.slices.alpha1[f.slices.alpha1.length-1])*c+")":a==="alpha2"?r.strokeStyle=n+Math.max(...f.slices.alpha2[f.slices.alpha2.length-1])*c+")":a==="beta"?r.strokeStyle=n+Math.max(...f.slices.beta[f.slices.beta.length-1])*c+")":a==="lowgamma"?r.strokeStyle=n+Math.max(...f.slices.lowgamma[f.slices.lowgamma.length-1])*c+")":a==="highgamma"&&(r.strokeStyle=n+Math.max(...f.slices.highgamma[f.slices.highgamma.length-1])*c+")"),r.beginPath(),r.moveTo(i+f.x0*this.scale,h-f.y0*this.scale),r.lineTo(i+f.x1*this.scale,h-f.y1*this.scale),r.stroke()}),this.updatePointsFromAtlas(e,l,!1)}}export class mirrorBarChart{constructor(t=null,e=null,l=null,a=1){this.div=document.getElementById(t),this.leftcanvasId-e,this.rightcanvasId=l,this.leftbars=new eegBarChart(e,a),this.rightbars=new eegBarChart(l,a),this.leftbars.ctx.rotate(90*(Math.PI/180)),this.rightbars.ctx.rotate(90*(Math.PI/180)),this.rightbars.ctx.translate(this.rightbars.canvas.width,0),this.rightbars.ctx.scale(-1,1)}deInit(){this.leftbars.deInit(),this.rightbars.deInit()}init(){this.leftbars.init(),this.rightbars.init()}updateCharts(t,e){this.leftbars.slices=t,this.rightbars.slices=e,this.leftbars.draw(),this.rightbars.draw()}}export class eegBarChart{constructor(t=null,e=1){v(this,"draw",()=>{var t=this.canvas.width,e=this.canvas.height,l=[...this.slices.scp,...this.slices.delta,...this.slices.theta,...this.slices.alpha,...this.slices.beta,...this.slices.lowgamma],a=l.length,s=t/this.relativeWidth,c=(this.meterWidth+this.meterGap)*s;this.canvas.context.clearRect(0,0,t,e);for(var i=0;i<a;i++){var h=l[i]*this.capYnormalizeFactor*e;h<0&&(h=0),capYPositionArray.length<Math.round(a)&&capYPositionArray.push(h),this.ctx.fillStyle=this.capStyle,h<capYPositionArray[i]?this.ctx.fillRect(i*c,e- --capYPositionArray[i],this.meterWidth*s,this.capHeight):(this.ctx.fillRect(i*c,e-h,this.meterWidth*s,this.capHeight),capYPositionArray[i]=h),this.ctx.fillStyle="white",i<this.slices.scp.length?this.ctx.fillStyle="purple":i<this.slices.scp.length+this.slices.delta.length?this.ctx.fillstyle="violet":i<this.slices.scp.length+this.slices.delta.length+this.slices.theta.length?this.ctx.fillstyle="blue":i<this.slices.scp.length+this.slices.delta.length+this.slices.theta.length+this.slices.alpha1.length?this.ctx.fillstyle="green":i<this.slices.scp.length+this.slices.delta.length+this.slices.theta.length+this.slices.alpha1.length+this.slices.alpha2.length?this.ctx.fillstyle="chartreuse":i<this.slices.scp.length+this.slices.delta.length+this.slices.theta.length+this.slices.alpha1.length+this.slices.alpha2.length+this.slices.beta.length?this.ctx.fillstyle="gold":i<this.slices.scp.length+this.slices.delta.length+this.slices.theta.length+this.slices.alpha1.length+this.slices.alpha2.length+this.slices.beta.length+this.slices.lowgamma.length&&(this.ctx.fillstyle="red"),this.ctx.fillRect(i*c,e-h+this.capHeight,this.meterWidth*s,e)}});v(this,"animate",()=>{this.draw(),setTimeout(()=>{this.anim!=="cancel"&&(this.anim=requestAnimationFrame(this.animate))},this.animationDelay)});this.canvasId=t,this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.anim=null,this.slices={scp:[0],delta:[0],theta:[0],alpha:[0],beta:[0],lowgamma:[0],highgamma:[0]},this.allCapsReachBottom=!1,this.meterWidth=14,this.meterGap=2,this.capHeight=2,this.capStyle="#fff",this.capYPositionArray=[],this.capYnormalizeFactor=e,this.relativeWidth=this.meterNum*(this.meterWidth+this.meterGap),this.animationDelay=15}deInit(){this.anim="cancel",cancelAnimationFrame(this.anim),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}init(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}}export class thetaGamma2Octave{constructor(t=null,e,l){this.canvasId=t,this.spect=new Spectrogram(t),this.anim=null,this.spect.normalizeFactor=e,this.adcScalingFactor=l,this.audio=null;try{this.makeAudioCtx()}catch(a){console.log(a)}}deInit(){this.audio=null,this.spect.deInit()}init(){this.makeAudioCtx(),this.spect.init()}makeAudioCtx(){this.audio=new SoundJS}getBandPowers(t,e){t.forEach((l,a)=>{e.map.forEach((s,c)=>{if(s.tag===l.tag){var i=Math.max(...s.slices.theta[s.slices.theta.length-1])*this.adcScalingFactor,h=Math.max(...s.slices.lowgamma[s.slices.lowgamma.length-1])*this.adcScalingFactor;return gammaMaxidx=s.slices.lowgamma.indexOf(h),gammaFreq=e.shared.bandFreqs.lowgamma[1][gammaMaxidx],i>5e-5&&this.audioctx.playFreq(450,.1,"sine"),h>3e-5&&i>1e-6&&this.audioctx.playFreq(800,.1,"sine"),!0}})})}updateSpect(t){this.spect.latestData=t,this.spect.draw()}}export class Spectrogram{constructor(t,e=1){v(this,"draw",()=>{var t=this.canvas.width,e=Math.floor(this.canvas.height),l=this.offscreenctx,a=l.canvas;l.drawImage(this.canvas,0,0,t,e);var s=[...this.latestData];if(s.length!==e){var c=s;s=this.interpolateArray(c,e)}var i=0;this.offset===!0&&(i=Math.pow(10,Math.floor(Math.log10(Math.min(...s))))),this.dynNormalize===!0&&(this.normalizeFactor=1/Math.pow(10,Math.floor(Math.log10(Math.max(...s))+.5)));for(var h=0;h<s.length;h++){var r=Math.floor((s[h]-i)*this.normalizeFactor*255);r>255?r=255:r<0&&(r=0),this.ctx.fillStyle=this.colorScale[r],this.ctx.fillRect(t-1,e-h,1,1)}this.reset===!1?(this.ctx.translate(-1,0),this.ctx.drawImage(a,0,0,t,e,0,0,t,e),this.ctx.drawImage(a,0,0,t,e,0,0,t,e),this.ctx.setTransform(1,0,0,1,0,0)):this.reset=!1,this.ctx.drawImage(this.canvas,0,0,t,e)});v(this,"animate",()=>{this.draw(),setTimeout(()=>{this.anim!=="cancel"&&(this.anim=requestAnimationFrame(this.animate))},this.animationDelay)});this.canvasId=t,this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.offscreen=null,this.offscreenctx=null,this.anim=null,this.reset=!1,this.offset=!0,this.colorScale=["#000000","#030106","#06010c","#090211","#0c0215","#0e0318","#10031b","#12041f","#130522","#140525","#150628","#15072c","#16082f","#160832","#160936","#160939","#17093d","#170a40","#170a44","#170a48","#17094b","#17094f","#170953","#170956","#16085a","#16085e","#150762","#140766","#140669","#13066d","#110571","#100475","#0e0479","#0b037d","#080281","#050185","#020089","#00008d","#000090","#000093","#000096","#000099","#00009c","#00009f","#0000a2","#0000a5","#0000a8","#0000ab","#0000ae","#0000b2","#0000b5","#0000b8","#0000bb","#0000be","#0000c1","#0000c5","#0000c8","#0000cb","#0000ce","#0000d1","#0000d5","#0000d8","#0000db","#0000de","#0000e2","#0000e5","#0000e8","#0000ec","#0000ef","#0000f2","#0000f5","#0000f9","#0000fc","#0803fe","#2615f9","#3520f4","#3f29ef","#4830eb","#4e37e6","#543ee1","#5944dc","#5e49d7","#614fd2","#6554cd","#6759c8","#6a5ec3","#6c63be","#6e68b9","#6f6db4","#7072af","#7177aa","#717ba5","#7180a0","#71859b","#718996","#708e91","#6f928b","#6e9786","#6c9b80","#6aa07b","#68a475","#65a96f","#62ad69","#5eb163","#5ab65d","#55ba56","#4fbf4f","#48c347","#40c73f","#36cc35","#34ce32","#37cf31","#3ad130","#3cd230","#3fd32f","#41d52f","#44d62e","#46d72d","#48d92c","#4bda2c","#4ddc2b","#4fdd2a","#51de29","#53e029","#55e128","#58e227","#5ae426","#5ce525","#5ee624","#60e823","#62e922","#64eb20","#66ec1f","#67ed1e","#69ef1d","#6bf01b","#6df11a","#6ff318","#71f416","#73f614","#75f712","#76f810","#78fa0d","#7afb0a","#7cfd06","#7efe03","#80ff00","#85ff00","#89ff00","#8eff00","#92ff00","#96ff00","#9aff00","#9eff00","#a2ff00","#a6ff00","#aaff00","#adff00","#b1ff00","#b5ff00","#b8ff00","#bcff00","#bfff00","#c3ff00","#c6ff00","#c9ff00","#cdff00","#d0ff00","#d3ff00","#d6ff00","#daff00","#ddff00","#e0ff00","#e3ff00","#e6ff00","#e9ff00","#ecff00","#efff00","#f3ff00","#f6ff00","#f9ff00","#fcff00","#ffff00","#fffb00","#fff600","#fff100","#ffec00","#ffe700","#ffe200","#ffdd00","#ffd800","#ffd300","#ffcd00","#ffc800","#ffc300","#ffbe00","#ffb900","#ffb300","#ffae00","#ffa900","#ffa300","#ff9e00","#ff9800","#ff9300","#ff8d00","#ff8700","#ff8100","#ff7b00","#ff7500","#ff6f00","#ff6800","#ff6100","#ff5a00","#ff5200","#ff4900","#ff4000","#ff3600","#ff2800","#ff1500","#ff0004","#ff000c","#ff0013","#ff0019","#ff001e","#ff0023","#ff0027","#ff002b","#ff012f","#ff0133","#ff0137","#ff013b","#ff023e","#ff0242","#ff0246","#ff0349","#ff034d","#ff0450","#ff0454","#ff0557","#ff065b","#ff065e","#ff0762","#ff0865","#ff0969","#ff0a6c","#ff0a70","#ff0b73","#ff0c77","#ff0d7a","#ff0e7e","#ff0f81","#ff1085","#ff1188","#ff128c","#ff138f","#ff1493"],this.latestData=null,this.animationDelay=15,this.normalizeFactor=1/e,this.dynNormalize=!0}interpolateArray(t,e){var l=this.canvas.height/t.length,a=function(o,m,x){return(o+(m-o)*x)*l},s=new Array,c=new Number((t.length-1)/(e-1));s[0]=t[0];for(var i=1;i<e-1;i++){var h=i*c,r=new Number(Math.floor(h)).toFixed(),n=new Number(Math.ceil(h)).toFixed(),f=h-r;s[i]=a(t[r],t[n],f)}return s[e-1]=t[t.length-1],s}deInit(){this.anim="cancel",cancelAnimationFrame(this.anim)}clear(){this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}init(){this.offscreen=new OffscreenCanvas(this.canvas.width,this.canvas.height),this.offscreenctx=this.offscreen.getContext("2d"),this.latestData=new Array(this.canvas.height).fill(0),this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.offscreenctx.fillStyle="black",this.offscreenctx.fillRect(0,0,this.canvas.width,this.canvas.height)}}export class Spectrogram3D{constructor(t,e=1){v(this,"animate",()=>{setTimeout(()=>{requestAnimationFrame(this.step)},this.animationDelay)});this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("webgl"),this.currentAmplitudes=[],this.lastAmplitudes=[],this.frequencies=[],this.peakAmp=e,this.triangleMesh=[],this.colorMesh=[],this.nSegments=0,this.meshMaxSegments=50,this.animationDelay=50}setColorFromIntensity(t){return t<.3334?(t*765,t*255):t<.6664&&t>.3334?((.6664-t)*255,t*128,1.5*t*255):(t*255,(1-t)*255)}gen3DVerticesStep(t,e,l,a=0){let s=[],c=[];for(let f=0;f<t.length-1;f++){s.push(t[f],a,e[f],t[f+1],a,e[f+1],t[f],a+1,l[f],t[f],a+1,l[f],t[f+1],a+1,l[f+1],t[f+1],a,e[f+1]);var i=e[f]/this.peakAmp,h=e[f+1]/this.peakAmp,r=l[f]/this.peakAmp,n=l[f+1]/this.peakAmp;i>1?i=1:i<0&&(i=0),h>1?h=1:h<0&&(h=0),r>1?r=1:r<0&&(r=0),n>1?n=1:n<0&&(n=0),c.push(setColorFromIntensity(i),setColorFromIntensity(h),setColorFromIntensity(r),setColorFromIntensity(r),setColorFromIntensity(n),setColorFromIntensity(h))}return[s,c]}step(t=this.currentAmplitudes,e=this.frequencies){this.lastAmplitudes=this.currentAmplitudes,this.currentAmplitudes=t,this.frequencies=e,this.nSegments>0&&this.triangleMesh.map((a,s)=>{(s-1)%3==0&&(a=a+1)});var l=this.gen3DVerticesStep(this.frequencies,this.lastAmplitudes,this.currentAmplitudes);this.triangleMesh.push(...l[0]),this.colorMesh.push(...l[1]),this.nSegments===this.meshMaxSegments?(this.triangleMesh.splice(0,this.frequencies.length*6),this.colorMesh.splice(0,this.frequencies.length*6)):this.nSegments++}}
