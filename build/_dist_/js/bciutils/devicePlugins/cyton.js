var l=(v,t,e)=>new Promise((s,i)=>{var n=a=>{try{o(e.next(a))}catch(h){i(h)}},r=a=>{try{o(e.throw(a))}catch(h){i(h)}},o=a=>a.done?s(a.value):Promise.resolve(a.value).then(n,r);o((e=e.apply(v,t)).next())});import"../../../../_snowpack/pkg/regenerator-runtime/runtime.js";export class cyton{constructor(t=this.onDecodedCallback,e=this.onConnectedCallback,s=this.onDisconnectedCallback,i="daisy",n=this.decode,r=115200){this.onDecodedCallback=t,this.onConnectedCallback=e,this.onDisconnectedCallback=s,this.decode=n,this.connected=!1,this.subscribed=!1,this.buffer=[],this.startByte=160,this.stopByte=192,this.searchString=new Uint8Array([this.stopByte,this.startByte]),this.readRate=16.666667,this.readBufferSize=2e3,this.sps=250,this.nChannels=16,this.nPeripheralChannels=6,this.updateMs=1e3/this.sps,this.stepSize=1/(Math.pow(2,23)-1),this.vref=4.5,this.gain=24,this.vscale=this.vref/this.gain*this.stepSize,this.uVperStep=1e6*(this.vref/this.gain*this.stepSize),this.scalar=1/(1e6/(this.vref/this.gain*this.stepSize)),this.maxBufferedSamples=this.sps*60*1,this.mode=i,this.data={count:0,startms:0,ms:[],A0:[],A1:[],A2:[],A3:[],A4:[],A5:[],A6:[],A7:[],A8:[],A9:[],A10:[],A11:[],A12:[],A13:[],A14:[],A15:[],Ax:[],Ay:[],Az:[],Gx:[],Gy:[],Gz:[]},this.resetDataBuffers(),navigator.serial||console.error("`navigator.serial not found! Enable #enable-experimental-web-platform-features in chrome://flags (search 'experimental')"),this.port=null,this.reader=null,this.baudrate=r}resetDataBuffers(){this.data.count=0,this.data.startms=0;for(const t in this.data)typeof this.data[t]=="object"&&(this.data[t]=new Array(this.maxBufferedSamples).fill(0))}setScalar(t=24,e=1/(Math.pow(2,23)-1),s=4.5){this.stepSize=e,this.vref=s,this.gain=t,this.vscale=this.vref/this.gain*this.stepSize,this.uVperStep=1e6*(this.vref/this.gain*this.stepSize),this.scalar=1/(1e6/(this.vref/this.gain*this.stepSize))}getLatestData(t="A0",e=1){let s=e;return s<=1?[this.data[t][this.data.count-1]]:(s>this.data.count&&(s=this.data.count),this.data[t].slice(this.data.count-s,this.data.count))}bytesToInt16(t,e){return t*256+e}int16ToBytes(t){return[t&255,t>>8&255]}bytesToInt24(t,e,s){return t*65536+e*256+s}int24ToBytes(t){return[t&255,t>>8&255,t>>16&255]}decode(t=this.buffer){var e=this.searchString,s=t,i=this.boyerMoore(e),n=i.byteLength,r=[];let o=0;for(var a=i(s);a!==-1;a=i(s,a+n))r.push(a);if(r.length>=2){for(let c=1;c<r.length;c++)if(r[c]-r[c-1]==32){var h=t.slice(r[c-1],r[c]+1);this.data.count<this.maxBufferedSamples&&this.data.count++,this.data.count-1==0?(this.data.ms[this.data.count-1]=Date.now(),this.data.startms=this.data.ms[0]):(this.data.ms[this.data.count-1]=this.data.ms[this.data.count-2]+this.updateMs,this.data.count>=this.maxBufferedSamples&&(this.data.ms.splice(0,5120),this.data.ms.push(new Array(5120).fill(0))));for(var a=3;a<27;a+=3){let d;this.mode==="daisy"?lines[2]%2!=0?d="A"+(a-3)/3:d="A"+(8+(a-3)/3):d="A"+(a-3)/3,this.data[d][this.data.count-1]=this.bytesToInt24(h[a],h[a+1],h[a+2]),this.data.count>=this.maxBufferedSamples&&(this.data[d].splice(0,5120),this.data[d].push(new Array(5120).fill(0)))}this.data.Ax[this.data.count-1]=this.bytesToInt16(h[27],h[28]),this.data.Ay[this.data.count-1]=this.bytesToInt16(h[29],h[30]),this.data.Az[this.data.count-1]=this.bytesToInt16(h[31],h[32]),this.data.count>=this.maxBufferedSamples&&(this.data.Ax.splice(0,5120),this.data.Ay.splice(0,5120),this.data.Az.splice(0,5120),this.data.Ax.push(new Array(5120).fill(0)),this.data.Ay.push(new Array(5120).fill(0)),this.data.Az.push(new Array(5120).fill(0)),this.data.count-=5120),o++}return o>0&&t.splice(0,r[r.length-1]),o}}onDecodedCallback(t){}onConnectedCallback(){console.log("port connected!")}onDisconnectedCallback(){console.log("port disconnected!")}onReceive(t){this.buffer.push(...t);let e=this.decode(this.buffer);e!==!1&&e!==0&&!isNaN(e)&&this.onDecodedCallback(e)}onPortSelected(s){return l(this,arguments,function*(t,e=this.baudrate){try{try{yield t.open({baudRate:e,bufferSize:this.readBufferSize}),this.onConnectedCallback(),this.connected=!0,this.subscribed=!0,this.subscribe(t)}catch(i){yield t.open({baudrate:e,buffersize:this.readBufferSize}),this.onConnectedCallback(),this.connected=!0,this.subscribed=!0,this.subscribe(t)}}catch(i){console.log(i),this.connected=!1}})}subscribe(t){return l(this,null,function*(){if(this.port.readable&&this.subscribed===!0){this.reader=t.readable.getReader();const e=()=>l(this,null,function*(){try{const{value:s,done:i}=yield this.reader.read();if((i||this.subscribed===!1)&&(yield this.reader.releaseLock()),s)try{this.onReceive(s)}catch(n){console.log(n)}this.subscribed===!0&&setTimeout(()=>{e()},this.readRate)}catch(s){console.log(s),this.closePort()}});e()}})}subscribeSafe(t){return l(this,null,function*(){var e=new Promise((s,i)=>{for(;this.port.readable&&this.subscribed===!0;){this.reader=t.readable.getReader();for(var n=!0,r=new Promise((a,h)=>this.reader.read()),o=new Promise((a,h)=>{setTimeout(a,100,"readfail")});n===!0;)Promise.race([r,o]).then(a=>{if(console.log("newpromise"),a==="readfail")console.log(a);else{const{value:c,done:f}=a;if(f===!0||this.subscribed===!0)var h=new Promise((d,b)=>{d(this.reader.releaseLock())}).then(()=>{n=!1});else this.onReceive(c)}})}s("not readable")})})}closePort(){return l(this,arguments,function*(t=this.port){this.port&&(this.subscribed=!1,setTimeout(()=>l(this,null,function*(){this.reader&&(this.reader=null),yield t.close(),this.port=null,this.connected=!1,this.onDisconnectedCallback()}),100))})}setupSerialAsync(){return l(this,arguments,function*(t=this.baudrate){const e=[{usbVendorId:4292,usbProductId:67}];this.port=yield navigator.serial.requestPort(),navigator.serial.addEventListener("disconnect",s=>{this.closePort(this.port)}),this.onPortSelected(this.port,t)})}asUint8Array(t){if(t instanceof Uint8Array)return t;if(typeof t=="string"){for(var e=new Uint8Array(t.length),s=0;s<t.length;s++){var i=t.charCodeAt(s);if(i>127)throw new TypeError("Only ASCII patterns are supported");e[s]=i}return e}else return new Uint8Array(t)}boyerMoore(t){var e=this.asUint8Array(t),s=e.length;if(s===0)throw new TypeError("patternBuffer must be at least 1 byte long");for(var i=256,n=new Int32Array(i),r=0;r<i;r++)n[r]=-1;for(var o=0;o<s;o++)n[e[o]]=o;var a=(h,c,f)=>{var d=this.asUint8Array(h);c===void 0&&(c=0),f===void 0&&(f=d.length);for(var b=e,m=n,g=f-b.length,w=b.length-1,p,y=c;y<=g;y+=p){p=0;for(var u=w;u>=0;u--){var A=d[y+u];if(b[u]!==A){p=Math.max(1,u-m[A]);break}}if(p===0)return y}return-1};return a.byteLength=e.byteLength,a}}
