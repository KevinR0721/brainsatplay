var l=(v,t,e)=>new Promise((s,r)=>{var n=a=>{try{o(e.next(a))}catch(i){r(i)}},h=a=>{try{o(e.throw(a))}catch(i){r(i)}},o=a=>a.done?s(a.value):Promise.resolve(a.value).then(n,h);o((e=e.apply(v,t)).next())});import"../../../_snowpack/pkg/regenerator-runtime/runtime.js";export class eeg32{constructor(t=this.onDecodedCallback,e=this.onConnectedCallback,s=this.onDisconnectedCallback,r=this.decode,n=115200){this.onDecodedCallback=t,this.onConnectedCallback=e,this.onDisconnectedCallback=s,this.decode=r,this.connected=!1,this.subscribed=!1,this.buffer=[],this.startByte=160,this.stopByte=192,this.searchString=new Uint8Array([this.stopByte,this.startByte]),this.readRate=16.666667,this.readBufferSize=2e3,this.sps=512,this.nChannels=32,this.nPeripheralChannels=6,this.updateMs=1e3/this.sps,this.stepSize=1/Math.pow(2,24),this.vref=2.5,this.gain=8,this.vscale=this.vref/this.gain*this.stepSize,this.uVperStep=1e6*(this.vref/this.gain*this.stepSize),this.scalar=1/(1e6/(this.vref/this.gain*this.stepSize)),this.maxBufferedSamples=this.sps*60*5,this.data={count:0,startms:0,ms:[],A0:[],A1:[],A2:[],A3:[],A4:[],A5:[],A6:[],A7:[],A8:[],A9:[],A10:[],A11:[],A12:[],A13:[],A14:[],A15:[],A16:[],A17:[],A18:[],A19:[],A20:[],A21:[],A22:[],A23:[],A24:[],A25:[],A26:[],A27:[],A28:[],A29:[],A30:[],A31:[],Ax:[],Ay:[],Az:[],Gx:[],Gy:[],Gz:[]},this.resetDataBuffers(),navigator.serial||console.error("`navigator.serial not found! Enable #enable-experimental-web-platform-features in chrome://flags (search 'experimental')"),this.port=null,this.reader=null,this.baudrate=n}resetDataBuffers(){this.data.count=0,this.data.startms=0;for(const t in this.data)typeof this.data[t]=="object"&&(this.data[t]=new Array(this.maxBufferedSamples).fill(0))}setScalar(t=24,e=1/(Math.pow(2,23)-1),s=4.5){this.stepSize=e,this.vref=s,this.gain=t,this.vscale=this.vref/this.gain*this.stepSize,this.uVperStep=1e6*(this.vref/this.gain*this.stepSize),this.scalar=1/(1e6/(this.vref/this.gain*this.stepSize))}getLatestData(t="A0",e=1){let s=e;return s<=1?[this.data[t][this.data.count-1]]:(s>this.data.count&&(s=this.data.count),this.data[t].slice(this.data.count-s,this.data.count))}bytesToInt16(t,e){return t*256+e}int16ToBytes(t){return[t&255,t>>8&255]}bytesToInt24(t,e,s){return t*65536+e*256+s}int24ToBytes(t){return[t&255,t>>8&255,t>>16&255]}decode(t=this.buffer){var e=this.searchString,s=t,r=this.boyerMoore(e),n=r.byteLength,h=[];let o=0;for(var a=r(s);a!==-1;a=r(s,a+n))h.push(a);if(h.length>=2){for(let c=1;c<h.length;c++)if(h[c]-h[c-1]==105){var i=t.slice(h[c-1],h[c]+1);this.data.count<this.maxBufferedSamples&&this.data.count++,this.data.count-1==0?(this.data.ms[this.data.count-1]=Date.now(),this.data.startms=this.data.ms[0]):(this.data.ms[this.data.count-1]=this.data.ms[this.data.count-2]+this.updateMs,this.data.count>=this.maxBufferedSamples&&(this.data.ms.splice(0,5120),this.data.ms.push(new Array(5120).fill(0))));for(var a=3;a<99;a+=3){var d="A"+(a-3)/3;this.data[d][this.data.count-1]=this.bytesToInt24(i[a],i[a+1],i[a+2]),this.data.count>=this.maxBufferedSamples&&(this.data[d].splice(0,5120),this.data[d].push(new Array(5120).fill(0)))}this.data.Ax[this.data.count-1]=this.bytesToInt16(i[99],i[100]),this.data.Ay[this.data.count-1]=this.bytesToInt16(i[101],i[102]),this.data.Az[this.data.count-1]=this.bytesToInt16(i[103],i[104]),this.data.count>=this.maxBufferedSamples&&(this.data.Ax.splice(0,5120),this.data.Ay.splice(0,5120),this.data.Az.splice(0,5120),this.data.Ax.push(new Array(5120).fill(0)),this.data.Ay.push(new Array(5120).fill(0)),this.data.Az.push(new Array(5120).fill(0)),this.data.count-=5120),o++}return o>0&&t.splice(0,h[h.length-1]),o}}onDecodedCallback(t){}onConnectedCallback(){console.log("port connected!")}onDisconnectedCallback(){console.log("port disconnected!")}onReceive(t){this.buffer.push(...t);let e=this.decode(this.buffer);e!==!1&&e!==0&&!isNaN(e)&&this.onDecodedCallback(e)}onPortSelected(s){return l(this,arguments,function*(t,e=this.baudrate){try{try{yield t.open({baudRate:e,bufferSize:this.readBufferSize}),this.onConnectedCallback(),this.connected=!0,this.subscribed=!0,this.subscribe(t)}catch(r){yield t.open({baudrate:e,buffersize:this.readBufferSize}),this.onConnectedCallback(),this.connected=!0,this.subscribed=!0,this.subscribe(t)}}catch(r){console.log(r),this.connected=!1}})}subscribe(t){return l(this,null,function*(){if(this.port.readable&&this.subscribed===!0){this.reader=t.readable.getReader();const e=()=>l(this,null,function*(){try{const{value:s,done:r}=yield this.reader.read();if((r||this.subscribed===!1)&&(yield this.reader.releaseLock()),s)try{this.onReceive(s)}catch(n){console.log(n)}this.subscribed===!0&&setTimeout(()=>{e()},this.readRate)}catch(s){console.log(s),this.closePort()}});e()}})}subscribeSafe(t){return l(this,null,function*(){var e=new Promise((s,r)=>{for(;this.port.readable&&this.subscribed===!0;){this.reader=t.readable.getReader();for(var n=!0,h=new Promise((a,i)=>this.reader.read()),o=new Promise((a,i)=>{setTimeout(a,100,"readfail")});n===!0;)Promise.race([h,o]).then(a=>{if(console.log("newpromise"),a==="readfail")console.log(a);else{const{value:d,done:c}=a;if(c===!0||this.subscribed===!0)var i=new Promise((f,b)=>{f(this.reader.releaseLock())}).then(()=>{n=!1});else this.onReceive(d)}})}s("not readable")})})}closePort(){return l(this,arguments,function*(t=this.port){this.port&&(this.subscribed=!1,setTimeout(()=>l(this,null,function*(){this.reader&&(this.reader=null),yield t.close(),this.port=null,this.connected=!1,this.onDisconnectedCallback()}),100))})}setupSerialAsync(){return l(this,arguments,function*(t=this.baudrate){const e=[{usbVendorId:4292,usbProductId:67}];this.port=yield navigator.serial.requestPort(),navigator.serial.addEventListener("disconnect",s=>{this.closePort(this.port)}),this.onPortSelected(this.port,t)})}asUint8Array(t){if(t instanceof Uint8Array)return t;if(typeof t=="string"){for(var e=new Uint8Array(t.length),s=0;s<t.length;s++){var r=t.charCodeAt(s);if(r>127)throw new TypeError("Only ASCII patterns are supported");e[s]=r}return e}else return new Uint8Array(t)}boyerMoore(t){var e=this.asUint8Array(t),s=e.length;if(s===0)throw new TypeError("patternBuffer must be at least 1 byte long");for(var r=256,n=new Int32Array(r),h=0;h<r;h++)n[h]=-1;for(var o=0;o<s;o++)n[e[o]]=o;var a=(i,d,c)=>{var f=this.asUint8Array(i);d===void 0&&(d=0),c===void 0&&(c=f.length);for(var b=e,g=n,m=c-b.length,w=b.length-1,p,A=d;A<=m;A+=p){p=0;for(var u=w;u>=0;u--){var y=f[A+u];if(b[u]!==y){p=Math.max(1,u-g[y]);break}}if(p===0)return A}return-1};return a.byteLength=e.byteLength,a}}
