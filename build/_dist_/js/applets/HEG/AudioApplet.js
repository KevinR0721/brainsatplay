var x=Object.defineProperty;var n=(l,e,i)=>(typeof e!="symbol"&&(e+=""),e in l?x(l,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[e]=i);import{brainsatplay as I}from"../../brainsatplay.js";import{DOMFragment as S}from"../../frontend/utils/DOMFragment.js";import{SoundJS as B}from"../../frontend/UX/Sound.js";export class AudioApplet{constructor(e=document.body,i=new I,t=[]){n(this,"drawMeter",()=>{var e=this.c.width,i=this.c.height,t=e/this.relativeWidth,s=new Uint8Array(this.audio.analyserNode.frequencyBinCount);if(this.audio.analyserNode.getByteFrequencyData(s),this.status===0){for(var a=s.length-1;a>=0;a--)s[a]=0;this.allCapsReachBottom=!0;for(var a=this.capYPositionArray.length-1;a>=0;a--)this.allCapsReachBottom=this.allCapsReachBottom&&this.capYPositionArray[a]===0;if(this.allCapsReachBottom){cancelAnimationFrame(this.animationId);return}}var o=Math.round(s.length*.75/this.meterNum);this.ctx.clearRect(0,0,e,i);for(var a=0;a<this.meterNum;a++){var d=s[a*o];this.capYPositionArray.length<this.meterNum&&this.capYPositionArray.push(d),this.capYPositionArray[a]=this.capYPositionArray[a]-.5,this.ctx.fillStyle=this.capStyle;var h=this.meterWidth*t+this.meterGap*t;d<this.capYPositionArray[a]?this.ctx.fillRect(a*h,i-this.capYPositionArray[a],this.meterWidth*t,this.capHeight):(this.ctx.fillRect(a*h,i-d,this.meterWidth*t,this.capHeight),this.capYPositionArray[a]=d),this.ctx.fillStyle=this.gradient,this.ctx.fillRect(a*h,i-d+this.capHeight,this.meterWidth*t,i)}});n(this,"drawLine",()=>{var e=this.c.width,i=this.c.height,t=e/this.relativeWidth,s=new Uint8Array(this.audio.analyserNode.frequencyBinCount);if(this.audio.analyserNode.getByteFrequencyData(s),this.status===0){for(var a=s.length-1;a>=0;a--)s[a]=0;this.allCapsReachBottom=!0;for(var a=this.capYPositionArray.length-1;a>=0;a--)this.allCapsReachBottom=this.allCapsReachBottom&&this.capYPositionArray[a]===0;if(this.allCapsReachBottom){cancelAnimationFrame(this.animationId);return}}var o=Math.round(s.length*.75/this.meterNum);this.ctx.clearRect(0,0,e,i),this.ctx.beginPath(),this.ctx.moveTo(0,i-this.capYPositionArray[0]*2);for(var a=0;a<this.meterNum;a++){var d=s[a*o];this.capYPositionArray[a]=d;var h=(this.meterWidth+this.meterGap)*t;this.ctx.lineTo(a*h,i-this.capYPositionArray[a]*2)}this.ctx.strokeStyle="red",this.ctx.stroke()});n(this,"drawCircle",()=>{var e=this.c.width*.5,i=this.c.height*.5,t=150,s=new Uint8Array(this.audio.analyserNode.frequencyBinCount);this.audio.analyserNode.getByteFrequencyData(s);var a=this.ctx.createRadialGradient(e,i,2,e,i,600+s[100]);a.addColorStop(0,"blue"),a.addColorStop(.25,"purple"),a.addColorStop(1,"rgba(255,69,0,0)"),this.ctx.fillStyle=a,this.ctx.fillRect(0,0,this.c.width,this.c.height);var o=this.ctx.createRadialGradient(e*.2,i*1.7,1,e*.2,i*1.7,2+s[2]*.5);o.addColorStop(0,"yellow"),o.addColorStop(.2,"greenyellow"),o.addColorStop(1,"rgba(255,69,0,0)"),this.ctx.fillStyle=o,this.ctx.fillRect(0,0,this.c.width,this.c.height);var d=this.ctx.createRadialGradient(e*.2,i*.3,1,e*.2,i*.3,2+s[200]*.5);d.addColorStop(0,"red"),d.addColorStop(.2,"crimson"),d.addColorStop(1,"rgba(255,69,0,0)"),this.ctx.fillStyle=d,this.ctx.fillRect(0,0,this.c.width,this.c.height);var h=this.ctx.createRadialGradient(e*1.8,i*.3,1,e*1.8,i*.3,2+s[100]*.5);h.addColorStop(0,"hotpink"),h.addColorStop(.2,"magenta"),h.addColorStop(1,"rgba(255,69,0,0)"),this.ctx.fillStyle=h,this.ctx.fillRect(0,0,this.c.width,this.c.height);var c=this.ctx.createRadialGradient(e*1.8,i*1.7,1,e*1.8,i*1.7,2+s[50]*.5);c.addColorStop(0,"deepskyblue"),c.addColorStop(.2,"skyblue"),c.addColorStop(1,"rgba(255,69,0,0)"),this.ctx.fillStyle=c,this.ctx.fillRect(0,0,this.c.width,this.c.height);for(var r=0;r<this.meterNum;r++){var u=Math.PI*2/this.meterNum,m=s[r],f=e+Math.cos(u*r)*t,p=i+Math.sin(u*r)*t,g=e+Math.cos(u*r)*(t+m),y=i+Math.sin(u*r)*(t+m),v="rgb("+s[r]+", "+s[r]+", "+205+")";this.ctx.strokeStyle=v,this.ctx.lineWidth=this.capHeight,this.ctx.beginPath(),this.ctx.moveTo(f,p),this.ctx.lineTo(g,y),this.ctx.stroke()}});n(this,"draw",()=>{if(this.bci.atlas.settings.heg){let e=this.bci.atlas.data.heg[0].count,i=40;e<i&&(i=e);let t=this.bci.atlas.data.heg[0].ratio.slice(e-i),s=this.bci.atlas.data.heg[0].ratio[e-1]-this.mean(t);this.onData(s)}this.mode==0?this.drawMeter():this.mode==1?this.drawLine():this.mode==2&&this.drawCircle(),setTimeout(()=>{this.animationId=requestAnimationFrame(this.draw)},15)});this.bci=i,this.parentNode=e,this.settings=t,this.AppletHTML=null,this.props={id:String(Math.floor(Math.random()*1e6))},this.c=null,this.ctx=null,this.gradient=null,this.hidden=!1,this.maxVol=.5,this.file=null,this.fileName=null,this.audio=null,this.info=null,this.menu=null,this.infoUpdateId=null,this.animationId=null,this.status=0,this.forceStop=!1,this.allCapsReachBottom=!1,this.useVol=!0,this.meterWidth=14,this.meterGap=2,this.capHeight=2,this.capStyle="#fff",this.meterNum=256,this.capYPositionArray=[],this.relativeWidth=this.meterNum*(this.meterWidth+this.meterGap),this.mode=2}init(){let e=(t=this.props)=>`
            <div id='`+t.id+`'> 
                <div id='`+t.id+`menu' style='position:absolute; z-index:2;'> 
                    <table id='`+t.id+`table' style='color:white;'>
                        <tr><td>Feedback: </td></tr> 
                        <tr><td><button id='`+t.id+`useVol'>Volume</button></td></tr> 
                        <tr><td><button id='`+t.id+`modebutton'>Mode</button></td></tr> 
                    </table>
                    <input type="range" id='`+t.id+`volSlider' min="0" max="100" value='`+this.maxVol*100+`'> 
                    <div id='`+t.id+`fileWrapper'> 
                        <div id='`+t.id+`fileinfo'></div> 
                        <input type="file" id='`+t.id+`uploadedFile'></input> 
                    </div> 
                </div> 
                <button id='`+t.id+`showhide' style='float:right; z-index:2'>Hide UI</button> 
                <canvas id='`+t.id+`canvas' style='z-index:1'></canvas> 
            </div> 
            `,i=(t=this.props)=>{this.c=document.getElementById(t.id+"canvas"),this.ctx=this.c.getContext("2d"),this.gradient=this.ctx.createLinearGradient(0,0,0,this.c.height),this.gradient.addColorStop(1,"springgreen"),this.gradient.addColorStop(.75,"yellow"),this.gradient.addColorStop(0,"red"),this.info=document.getElementById(this.props.id+"fileinfo").innerHTML,this.menu=document.getElementById(this.props.id+"menu"),document.getElementById(t.id+"useVol").onclick=()=>{this.useVol==!1?(this.useVol=!0,document.getElementById(t.id+"useVol").style.opacity="1.0"):(this.useVol=!1,this.maxVol=document.getElementById(t.id+"volSlider").value*.01,this.audio.gainNode!=null&&this.audio.gainNode.gain.setValueAtTime(this.maxVol,this.audio.ctx.currentTime),document.getElementById(t.id+"useVol").style.opacity="0.3")},document.getElementById(t.id+"volSlider").oninput=()=>{this.maxVol=document.getElementById(t.id+"volSlider").value*.01,this.audio.gainNode!=null&&this.audio.gainNode.gain.setValueAtTime(this.maxVol,this.audio.ctx.currentTime)},document.getElementById(t.id+"modebutton").onclick=()=>{this.mode==0?this.mode=1:this.mode==1?this.mode=2:this.mode=0},document.getElementById(t.id+"showhide").onclick=()=>{this.hidden==!1?(this.hidden=!0,document.getElementById(t.id+"showhide").innerHTML="Show UI",document.getElementById(t.id+"menu").style.display="none"):(this.hidden=!1,document.getElementById(t.id+"showhide").innerHTML="Hide UI",document.getElementById(t.id+"menu").style.display="")}};this.AppletHTML=new S(e,this.parentNode,this.props,i,void 0,"NEVER"),this.settings.length>0&&this.configure(this.settings),this.initVisualizer()}deinit(){this.stopAudio(),this.AppletHTML.deleteNode()}responsive(){this.c.width=this.AppletHTML.node.clientWidth,this.c.height=this.AppletHTML.node.clientHeight}configure(e=[]){e.forEach((i,t)=>{})}stopAudio(){this.animationId!==null&&cancelAnimationFrame(this.animationId),this.audio!==null&&this.audio.sourceList.length>0&&this.audio.sourceList[0].stop(0)}createVisualizer(e){this.audio.finishedLoading([e]),this.audio.sourceList[0].start(0),this.audio.gainNode.gain.setValueAtTime(this.maxVol,this.audio.ctx.currentTime),this.status=1,this.audio.sourceList[0].onended=()=>{this.endAudio()},this.updateInfo("Playing "+this.fileName,!1),this.info="Playing "+this.fileName,document.getElementById(this.props.id+"fileWrapper").style.opacity=.2,this.draw()}onData(e){if(this.useVol==!0){var i=this.audio.gainNode.gain.value+e;i>this.maxVol&&(i=this.maxVol),i<0&&(i=0),this.defaultUI==!0&&(document.getElementById(this.props.id+"volSlider").value=i*100),this.audio.gainNode.gain.value=i}}endAudio(){if(this.forceStop){this.forceStop=!1,this.status=1;return}this.status=0;var e="Song ended...";document.getElementById(this.props.id+"fileWrapper").style.opacity=1,document.getElementById(this.props.id+"fileinfo").innerHTML=e,this.info=e,document.getElementById(this.props.id+"uploadedFile").value=""}updateInfo(e,i){var t=document.getElementById(this.props.id+"fileinfo"),s="...",a=0;if(t.innerHTML=e+s.substring(0,a++),this.infoUpdateId!==null&&clearTimeout(this.infoUpdateId),i){var o=()=>{a>3&&(a=0),t.innerHTML=e+s.substring(0,a++),this.infoUpdateId=setTimeout(o,250)};this.infoUpdateId=setTimeout(o,250)}}decodeAudio(){var e=this.file,i=new FileReader;i.onload=t=>{var s=t.target.result;this.audio.ctx!==null&&(this.updateInfo("Decoding the audio",!0),this.audio.ctx.decodeAudioData(s,a=>{this.updateInfo("Decode successful, starting the visualizer",!0),this.createVisualizer(a)},a=>{this.updateInfo("Failed to decode the file!",!1),console.error(a)}))},i.onerror=function(t){this.updateInfo("Failed to read the file!",!1),console.error(t)},this.updateInfo("Starting read the file",!0),i.readAsArrayBuffer(e)}initVisualizer(){var e=document.getElementById(this.props.id+"uploadedFile"),i=document.getElementById(this.props.id+"canvas");e.onchange=()=>{this.audio=new B,this.audio.ctx!==null&&e.files.length!==0&&(this.file=e.files[0],this.fileName=this.file.name,this.status===1&&(this.forceStop=!0),document.getElementById(this.props.id+"fileWrapper").style.opacity=1,this.updateInfo("Uploading",!0),this.decodeAudio())},i.addEventListener("dragenter",()=>{document.getElementById(this.props.id+"fileWrapper").style.opacity=1,this.updateInfo("Drop it on the page",!0)},!1),i.addEventListener("dragover",function(t){t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy"},!1),i.addEventListener("dragleave",()=>{document.getElementById(this.props.id+"fileWrapper").style.opacity=.2,this.updateInfo(this.info,!1)},!1),i.addEventListener("drop",t=>{t.stopPropagation(),t.preventDefault(),this.audio.ctx!==null&&(document.getElementById(this.props.id+"fileWrapper").style.opacity=1,this.updateInfo("Uploading",!0),this.file=t.dataTransfer.files[0],this.status===1&&(document.getElementById(this.props.id+"fileWrapper").style.opacity=1,this.forceStop=!0),this.fileName=this.file.name,this.decodeAudio())},!1)}}n(AudioApplet,"devices",["heg"]);
