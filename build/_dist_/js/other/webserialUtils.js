var f=Object.defineProperty;var h=(c,e,t)=>(typeof e!="symbol"&&(e+=""),e in c?f(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t);var d=(c,e,t)=>new Promise((o,i)=>{var n=s=>{try{a(t.next(s))}catch(l){i(l)}},r=s=>{try{a(t.throw(s))}catch(l){i(l)}},a=s=>s.done?o(s.value):Promise.resolve(s.value).then(n,r);a((t=t.apply(c,e)).next())});export class webSerial{constructor(e=!0,t="serialmenu",o="serialmonitor"){h(this,"onGetDevices",e=>{document.getElementById("serialports").innerHTML="";for(var t=[],o=0;o<e.length;o++)console.log(e[o].path);e.forEach(i=>{var n=i.displayName+"("+i.path+")";if(console.log("displayName "+n),n||(n=i.path),t.push({option:n,value:i.path}),console.log(this.defaultUI),this.defaultUI==!0){var r=document.createElement("option");r.text=n,r.value=i.path,console.log("option",r),document.getElementById("serialports").appendChild(r)}}),this.displayPorts=t});h(this,"onReceive",e=>{if(e.connectionId!==this.connectionId){console.log("ERR: Receive ID:",e.connectionId);return}var t=new Uint8Array(e.data),o=String.fromCharCode.apply(null,t);this.encodedBuffer+=decodeURIComponent(escape(o)),console.log(this.encodedBuffer.length);for(var i;(i=this.encodedBuffer.indexOf(`
`))>=0;){var n=this.encodedBuffer.substr(0,i+1);this.recordData==!0&&this.recorded.push(n),(this.monitoring=!0)&&(this.newSamples++,this.monitorData.push(n)),this.onReadLine(n),this.encodedBuffer=this.encodedBuffer.substr(i+1)}});h(this,"onConnectComplete",e=>{this.connectionId=e.connectionId,console.log("Connected! ID:",this.connectionId),chrome.serial.onReceive.addListener(this.onReceive),chrome.serial.onReceiveError.addListener(this.onReceiveError),this.finalCallback()});this.displayPorts=[],this.defaultUI=e,this.encodedBuffer="",this.connectionId=-1,this.recordData=!1,this.recorded=[],this.port=null,this.decoder=null,this.monitoring=!1,this.newSamples=0,this.monitorSamples=1e4,this.monitorData=[],this.monitorIdx=0,chrome.serial?(e==!0&&this.setupSelect(t),this.setupSerial()):navigator.serial?(this.decoder=new TextDecoder,e==!0&&this.setupSelect(t)):(console.log("ERROR: Cannot locate navigator.serial. Enable #experimental-web-platform-features in chrome://flags"),alert("Serial support not found. Enable #experimental-web-platform-features in chrome://flags or use a chrome extension"))}setupSelect(e){if(chrome.serial){var t=document.createElement("select");t.setAttribute("id","serialports");var o=document.createDocumentFragment();o.appendChild(t),document.getElementById(e).innerHTML='<button id="refreshSerial">Get</button><button id="connectSerial">Set</button>',document.getElementById(e).appendChild(o),document.getElementById("refreshSerial").onclick=()=>{this.setupSerial()},document.getElementById("connectSerial").onclick=()=>{this.connectionId!=-1&&this.connectSelected(!1),this.connectSelected(!0,document.getElementById("serialports").option,document.getElementById("serialports").value)}}else if(navigator.serial){var o=document.createDocumentFragment();document.getElementById(e).innerHTML='<button id="refreshSerial">Connect</button>',document.getElementById(e).appendChild(o)}document.getElementById("refreshSerial").onclick=()=>{this.setupSerialAsync()}}setupMonitor(e){this.monitorData.length>this.monitorSamples&&this.monitorData.splice(0,this.monitorData.length-this.monitorSamples);var t=document.createElement("div");t.setAttribute("id","streamMonitor"),this.monitorData.forEach((n,r)=>{t.innerHTML+="<div id="+this.monitorIdx+">"+n+"</div>",this.monitorIdx++}),this.newSamples=0;var o=document.createDocumentFragment();o.appendChild(t),document.getElementById(e).appendChild(o);var i=()=>{if(this.newSamples>0){if(this.monitorData.length>this.monitorSamples){for(var n=this.monitorIdx-this.monitorSamples-(this.monitorData.length-this.monitorSamples);n>this.monitorIdx-this.monitorSamples;n++)document.getElementById(n).remove();this.monitorData.splice(0,this.monitorData.length-this.monitorSamples)}for(var n=0;n<newSamples;n++){var r=document.createElement("div");r.innerHTML='<div id="'+this.monitorIdx+'">'+this.monitorData[this.monitorData.length-1-n]+"</div>";var a=document.createDocumentFragment();a.appendChild(r),document.getElementById(e).appendChild(a),this.monitorIdx++;var s=document.getElementById("streamMonitor");s.scrollTop=s.scrollHeight}setTimeout(requestAnimationFrame(i),15)}};requestAnimationFrame(i)}onReceiveError(e){console.log("onReceiveError"),e.connectionId===this.connectionId&&(console.log("Error from ID:",e.connectionId),this.onError.dispatch(e.error),console.log("Error: "+e.error))}finalCallback(){console.log("USB device Ready!")}sendMessage(e){e+=`
`;for(var t=unescape(encodeURIComponent(e)),o=new Uint8Array(t.length),i=0;i<t.length;++i)o[i]=t.charCodeAt(i);chrome.serial?this.connectionId>-1?(chrome.serial.send(this.connectionId,o.buffer,this.onSendCallback),console.log("Send message:",e)):console.log("Device is disconnected!"):navigator.serial&&this.port.writable&&this.sendMessageAsync(o.buffer)}onSendCallback(e){console.log("sendInfo",e)}onReadLine(e){console.log(e)}connectSelected(e=!0,t="",o=""){if(e==!0&&o!="")console.log("Connecting",o),t.indexOf("STM")>-1?chrome.serial.connect(o,{bitrate:921600},this.onConnectComplete):chrome.serial.connect(o,{bitrate:115200},this.onConnectComplete);else{if(console.log("Disconnect"+o),this.connectionId<0){console.log("connectionId",this.connectionId);return}this.encodedBuffer="",chrome.serial.onReceive.removeListener(this.onReceive),chrome.serial.onReceiveError.removeListener(this.onReceiveError),chrome.serial.flush(this.connectionId,function(){console.log("chrome.serial.flush",this.connectionId)}),chrome.serial.disconnect(this.connectionId,function(){console.log("chrome.serial.disconnect",this.connectionId)})}}setupSerial(){chrome.serial.getDevices(this.onGetDevices)}sendMessageAsync(e){return d(this,null,function*(){const t=this.port.writable.getWriter();yield t.write(e),t.releaseLock()})}onPortSelected(e){return d(this,null,function*(){try{yield e.open({baudrate:115200})}catch(t){yield e.open({baudRate:115200})}this.finalCallback(),this.subscribe(e)})}onReceiveAsync(e){this.encodedBuffer+=this.decoder.decode(e);for(var t;(t=this.encodedBuffer.indexOf(`
`))>=0;){var o=this.encodedBuffer.substr(0,t+1);this.recordData==!0&&this.recorded.push(o),(this.monitoring=!0)&&(this.newSamples++,this.monitorData.push(o)),this.onReadLine(o),this.encodedBuffer=this.encodedBuffer.substr(t+1)}}subscribe(e){return d(this,null,function*(){for(;this.port.readable;){const t=e.readable.getReader();try{for(;;){const{value:o,done:i}=yield t.read();if(i){t.releaseLock();break}o&&this.onReceiveAsync(o)}}catch(o){console.log(o);break}}})}closePort(){return d(this,null,function*(){yield this.port.close(),this.port=null})}setupSerialAsync(){return d(this,null,function*(){const e=[{usbVendorId:4292,usbProductId:67}];this.port=yield navigator.serial.requestPort(),navigator.serial.addEventListener("disconnect",t=>{this.closePort()}),this.onPortSelected(this.port)})}saveCsv(e=this.recorded,t=new Date().toISOString(),o="|",i=`Header
`){var n=i;e.forEach(a=>{n+=a.split(o).join(",")+`
`});var r=document.createElement("a");r.href="data:text/csv;charset=utf-8,"+encodeURI(n),r.target="_blank",t!=""?r.download=t+".csv":r.download=new Date().toISOString()+".csv",r.click()}openFile(e=","){var t=document.createElement("input");t.type="file",t.onchange=o=>{this.csvDat=[];var i=o.target.files[0],n=new FileReader;n.readAsText(i),n.onload=r=>{var a=r.target.result,s=a.split(`
`);s.pop(),s.forEach((l,u)=>{if(u==0)var m=l.split(e);else{var m=l.split(e);this.csvDat.push(m)}}),this.onOpen()},t.value=""},t.click()}onOpen(){alert("CSV Opened!")}}
