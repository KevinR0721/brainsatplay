var u=Object.defineProperty;var l=(c,e,t)=>(typeof e!="symbol"&&(e+=""),e in c?u(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t);class chromeSerial{constructor(e=!0,t="serialmenu",i="serialmonitor"){l(this,"onGetDevices",e=>{document.getElementById("serialports").innerHTML="";for(var t=[],i=0;i<e.length;i++)console.log(e[i].path);e.forEach(n=>{var o=n.displayName+"("+n.path+")";if(console.log("displayName "+o),o||(o=n.path),t.push({option:o,value:n.path}),console.log(this.defaultUI),this.defaultUI==!0){var r=document.createElement("option");r.text=o,r.value=n.path,console.log("option",r),document.getElementById("serialports").appendChild(r)}}),this.displayPorts=t});l(this,"onReceive",e=>{var t=new Uint8Array(e.data),i=String.fromCharCode.apply(null,t);this.encodedBuffer+=decodeURIComponent(escape(i));for(var n;(n=this.encodedBuffer.indexOf(`
`))>=0;){var o=this.encodedBuffer.substr(0,n+1);this.recordData==!0&&this.recorded.push(o),(this.monitoring=!0)&&(this.newSamples++,this.monitorData.push(o)),this.onReadLine(o),this.encodedBuffer=this.encodedBuffer.substr(n+1)}});l(this,"onConnectComplete",e=>{this.connectionId=e.connectionId,console.log("Connected! ID:",this.connectionId),chrome.serial.onReceive.addListener(this.onReceive),chrome.serial.onReceiveError.addListener(this.onReceiveError),this.finalCallback()});this.displayPorts=[],this.defaultUI=e,this.encodedBuffer="",this.connectionId=-1,this.recordData=!1,this.recorded=[],this.monitoring=!1,this.newSamples=0,this.monitorSamples=1e4,this.monitorData=[],this.monitorIdx=0,typeof chrome.serial!="undefined"&&chrome.serial!==null?(e==!0&&this.setupSelect(t),this.setupSerial()):console.log("ERROR: Cannot locate chrome.serial.")}setupSelect(e){var t=document.createElement("select");t.setAttribute("id","serialports");var i=document.createDocumentFragment();i.appendChild(t),document.getElementById(e).innerHTML='<button id="refreshSerial">Get</button><button id="connectSerial">Set</button>',document.getElementById(e).appendChild(i),document.getElementById("refreshSerial").onclick=()=>{this.setupSerial()},document.getElementById("connectSerial").onclick=()=>{this.connectionId!=-1&&this.connectSelected(!1),this.connectSelected(!0,document.getElementById("serialports").value)}}setupMonitor(e){this.monitorData.length>this.monitorSamples&&this.monitorData.splice(0,this.monitorData.length-this.monitorSamples);var t=document.createElement("div");t.setAttribute("id","streamMonitor"),this.monitorData.forEach((o,r)=>{t.innerHTML+="<div id="+this.monitorIdx+">"+o+"</div>",this.monitorIdx++}),this.newSamples=0;var i=document.createDocumentFragment();i.appendChild(t),document.getElementById(e).appendChild(i);var n=()=>{if(this.newSamples>0){if(this.monitorData.length>this.monitorSamples){for(var o=this.monitorIdx-this.monitorSamples-(this.monitorData.length-this.monitorSamples);o>this.monitorIdx-this.monitorSamples;o++)document.getElementById(o).remove();this.monitorData.splice(0,this.monitorData.length-this.monitorSamples)}for(var o=0;o<newSamples;o++){var r=document.createElement("div");r.innerHTML='<div id="'+this.monitorIdx+'">'+this.monitorData[this.monitorData.length-1-o]+"</div>";var s=document.createDocumentFragment();s.appendChild(r),document.getElementById(e).appendChild(s),this.monitorIdx++;var a=document.getElementById("streamMonitor");a.scrollTop=a.scrollHeight}setTimeout(requestAnimationFrame(n),15)}};requestAnimationFrame(n)}onReceiveError(e){console.log("onReceiveError"),e.connectionId===this.connectionId&&(console.log("Error from ID:",e.connectionId),this.onError.dispatch(e.error),console.log("Error: "+e.error))}finalCallback(){console.log("USB device Ready!")}sendMessage(e){if(e+=`
`,typeof chrome.serial!="undefined"&&chrome.serial!==null)if(this.connectionId>-1){for(var t=unescape(encodeURIComponent(e)),i=new Uint8Array(t.length),n=0;n<t.length;++n)i[n]=t.charCodeAt(n);chrome.serial.send(this.connectionId,i.buffer,this.onSendCallback),console.log("Send message:",e)}else console.log("Device is disconnected!")}onSendCallback(e){console.log("sendInfo",e)}onReadLine(e){console.log(e)}connectSelected(e=!0,t=""){if(e==!0&&t!="")console.log("Connecting",t),chrome.serial.connect(t,{bitrate:115200},this.onConnectComplete);else{if(console.log("Disconnect"+t),this.connectionId<0){console.log("connectionId",this.connectionId);return}this.encodedBuffer="",chrome.serial.onReceive.removeListener(this.onReceive),chrome.serial.onReceiveError.removeListener(this.onReceiveError),chrome.serial.flush(this.connectionId,function(){console.log("chrome.serial.flush",this.connectionId)}),chrome.serial.disconnect(this.connectionId,function(){console.log("chrome.serial.disconnect",this.connectionId)})}}setupSerial(){chrome.serial.getDevices(this.onGetDevices)}saveCsv(e=this.recorded,t=new Date().toISOString(),i="|",n=`Header
`){var o=n;e.forEach(s=>{o+=s.split(i).join(",")+`
`});var r=document.createElement("a");r.href="data:text/csv;charset=utf-8,"+encodeURI(o),r.target="_blank",t!=""?r.download=t+".csv":r.download=new Date().toISOString()+".csv",r.click()}openFile(e=","){var t=document.createElement("input");t.type="file",t.onchange=i=>{this.csvDat=[];var n=i.target.files[0],o=new FileReader;o.readAsText(n),o.onload=r=>{var s=r.target.result,a=s.split(`
`);a.pop(),a.forEach((d,m)=>{if(m==0)var h=d.split(e);else{var h=d.split(e);this.csvDat.push(h)}}),this.onOpen()},t.value=""},t.click()}onOpen(){alert("CSV Opened!")}}
