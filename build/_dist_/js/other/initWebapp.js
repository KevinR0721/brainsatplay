import{HEGwebAPI as l,graphJS as T,circleJS as B,audioJS as I,videoJS as S,hillJS as C,textReaderJS as _,boidsJS as k,bleUtils as P}from"./HEGwebAPI.js";import{ThreeGlobe as A}from"./threeApp.js";import{webSerial as L}from"./webserialUtils.js";var n=new l("",void 0,void 0,void 0,void 0,!1);if(window.location.hostname!=="192.168.4.1"&&window.location.hostname!=="esp32.local")var b=!0;var M='<label class="switch"><input type="checkbox" id="togBtn"><div class="startslider round"></div></label>',D='<button id="wifibutton">WiFi Device</button>',R='<div id="tabContainer">     <button class="tablink" id="modal_opener">Data</button>     <button class="tablink" id="modal_opener2">Graph</button>     <button class="tablink" id="modal_opener3">Feedback</button>     </div>     <div id="modal" class="modal" style="display: none">     <div id="overlay" class="overlay"></div>       <div class="modal_content databoxmodal">         <h2>Data Options</h2>         <div id="dataBox"></div>         <button title="Close" id="close_modal" class="close_modal">             <i class="fas fa-times"></i>         </button>       </div>     </div>     <div id="modal2" class="modal" style="display: none">     <div id="overlay2" class="overlay"></div>       <div id="graphBox" class="modal_content graphboxmodal">         <h2>Graph Options</h2>         <button title="Close" id="close_modal2" class="close_modal">             <i class="fas fa-times"></i>         </button>       </div>     </div>     <div id="modal3" class="modal" style="display: none">     <div id="overlay3" class="overlay"></div>       <div id = "visualBox" class="modal_content feedbackboxmodal">         <h2>Feedback Options</h2>         <button title="Close" id="close_modal3" class="close_modal">             <i class="fas fa-times"></i>         </button>       </div>     </div>';l.appendFragment(M,"main_body"),l.appendFragment(R,"main_body"),l.appendFragment(D,"main_body");function G(t,o,i){document.getElementById(o).onclick=function(){p(t,o,i)},document.getElementById(i).onclick=function(){p(t,o,i)}}function H(t,o,i){document.getElementById(o).onclick=function(){p(t,o,i)},document.getElementById(i).onclick=function(){p(modalelm,o,i)}}function p(t,o,i){var E=t.style.display;E==="none"?(t.style.display="block",t.style.opacity="1.0",G(t,o,i)):(t.style.display="none",t.style.opacity="0.0",H(t,o,i))}var F=document.getElementById("modal"),V=document.getElementById("modal2"),U=document.getElementById("modal3");document.getElementById("modal_opener").onclick=function(){p(F,"close_modal","overlay"),this.modal2.style.display="none",this.modal3.style.display="none"},document.getElementById("modal_opener2").onclick=function(){p(V,"close_modal2","overlay2"),this.modal.style.display="none",this.modal3.style.display="none"},document.getElementById("modal_opener3").onclick=function(){p(U,"close_modal3","overlay3"),this.modal.style.display="none"};function J(t){t.checked?document.getElementById("startbutton").click():document.getElementById("stopbutton").click()}document.getElementById("togBtn").onclick=function(){J(document.getElementById("togBtn"))},document.getElementById("wifibutton").onclick=()=>{document.getElementById("submithost").click()};var e=new T(1155,[255,100,80,1],1,[1400,600],"main_body","g",!1);n.createUI("dataBox"),e.createUI("graphBox");var c=null,u=null,r=null,h=null,m=null,f=new k,N=!1,j='<div class="menudiv" id="menudiv">     Modes:<br>     <button class="button" id="canvasmode">Circle</button>     <button class="button" id="videomode">Video</button><br>     <button class="button" id="audiomode">Audio</button>     <button class="button" id="hillmode">Hill Climb</button><br>     <button class="button" id="txtmode">Text Reader</button>     <button class="button" id="boidsmode">Birdoids</button>     </div>';if(l.appendFragment(j,"visualBox"),document.getElementById("canvasmode").onclick=function(){c==null&&(s(),c=new B)},document.getElementById("videomode").onclick=function(){u==null&&(s(),u=new S)},document.getElementById("audiomode").onclick=function(){r==null&&(s(),r=new I)},document.getElementById("hillmode").onclick=function(){h==null&&(s(),h=new C)},document.getElementById("txtmode").onclick=function(){m==null&&(s(),m=new _)},document.getElementById("boidsmode").onclick=function(){f==null&&(s(),f=new k)},b){var Y=document.createElement("script");Y.src="js/threeApp.js",document.head.appendChild(Y);var g=null,O='<button class="button" id="threemode">Sunrise</button>';l.appendFragment(O,"menudiv"),document.getElementById("threemode").onclick=function(){g==null&&(s(),g=new A)}}n.handleScore=function(){if(e.clock=this.clock[this.clock.length-1]-this.startTime,this.ratio.length>40){e.sampleRate==null&&(n.useMs==!0?e.sampleRate=(this.clock[this.clock.length-1]-this.clock[0])*.001/this.clock.length:e.sampleRate=(this.clock[this.clock.length-1]-this.clock[0])*1e-6/this.clock.length),this.smaScore(this.ratio);var t=this.smaSlope*this.sensitivity.value*.01;c!=null&&c.onData(t),u!=null&&u.onData(t),r!=null&&r.onData(t),h!=null&&h.onData(t),m!=null&&m.onData(t),f!=null&&f.onData(t),b&&g!=null&&g.onData(t),this.scoreArr.push(this.scoreArr[this.scoreArr.length-1]+t),e.ratio=this.slowSMA,e.score=this.scoreArr[this.scoreArr.length-1],e.graphY1.shift(),e.graphY1.push(this.scoreArr[this.scoreArr.length-1-e.xoffset]),e.graphY2.shift(),e.graphY2.push(this.slowSMAarr[this.slowSMAarr.length-1-e.xoffset])}},n.endOfEvent=function(){N!==!0&&document.getElementById("togBtn").checked==!1&&(document.getElementById("togBtn").checked=!0),e.xoffsetSlider.max<this.scoreArr.length&&this.scoreArr.length%20==0&&(e.xoffsetSlider.max=this.scoreArr.length-3)};function s(){u!=null&&(l.removeParent(u.vidapiId),l.removeParent(u.vidContainerId),u.deInit(),u=null),r!=null&&(r.stopAudio(),r.endAudio(r),l.removeParent(r.audioId),l.removeParent(r.audmenuId),r=null),c!=null&&(c.deInit(),l.removeParentParent(c.canvasId),l.removeParent(c.canvasmenuId),c=null),h!=null&&(h.deInit(),l.removeParentParent(h.canvasId),l.removeParent(h.canvasmenuId),h=null),m!=null&&(m.deInit(),l.removeParentParent(m.canvasId),l.removeParent(m.canvasmenuId),m=null),f!=null&&(f.deInit(),l.removeParentParent(f.canvasId),f=null),b&&g!=null&&(g.destroyThreeApp(),g=null)}document.getElementById("resetSession").onclick=()=>{n.resetVars(),e.resetVars(),c!=null&&(s(),c=new B),u!=null&&(s(),u=new S),r!=null&&(s(),r=new I),h!=null&&(s(),h=new C),m!=null&&(s(),m=new _),f!=null&&(s(),f=new k),b&&g!=null&&(s(),g=new A)},e.xoffsetSlider.onchange=()=>{if(e.xoffsetSlider.value>n.scoreArr.length&&(e.xoffsetSlider.value=n.scoreArr.length-1),e.xoffset=e.xoffsetSlider.value,n.scoreArr.length>e.graphY1.length){var t=n.scoreArr.length-e.xoffset-1;e.graphY1=n.scoreArr.slice(t-e.graphY1.length,t),e.graphY2=n.ratio.slice(t-e.graphY2.length,t)}else if(n.scoreArr.length<e.graphY1.length){var o=n.scoreArr.slice(0,n.scoreArr.length-1-e.xoffset),i=n.ratio.slice(0,n.ratio.length-1-e.xoffset);e.graphY1.length==o?(e.graphY1=o,e.graphY2=i):(e.graphY1=[...Array(e.VERTEX_LENGTH-o.length).fill(0),...o],e.graphY2=[...Array(e.VERTEX_LENGTH-i.length).fill(0),...i])}},e.xscaleSlider.onchange=()=>{if(len=e.graphY1.length,e.xscaleSlider.value<len)for(var t=0;t<len-e.xscaleSlider.value;t++)e.graphY1.shift(),e.graphY2.shift();if(e.xscaleSlider.value>len)for(var t=0;t<e.xscaleSlider.value-len;t++)t+len+e.xoffset<=n.scoreArr.length?(e.graphY1.unshift(n.scoreArr[n.scoreArr.length-(len+t+e.xoffset)]),e.graphY2.unshift(n.ratio[n.ratio.length-(len+t+e.xoffset)])):(e.graphY1.unshift(0),e.graphY2.unshift(0));e.VERTEX_LENGTH=e.graphY1.length},document.getElementById("xscalebutton").onclick=()=>{var t=e.graphY1.length;if(e.xscaleSlider.value=e.nPoints,e.xscaleSlider.value<t)for(var o=0;o<t-e.xscaleSlider.value;o++)e.graphY1.shift(),e.graphY2.shift();if(e.xscaleSlider.value>t)for(var o=0;o<e.xscaleSlider.value-t;o++)e.xscaleSlider.value<n.scoreArr.length?(e.graphY1.unshift(n.scoreArr[n.scoreArr.length-1-(e.graphY1.length+o+e.xoffset)]),e.graphY2.unshift(n.ratio[n.ratio.length-1-(e.graphY2.length+o+e.xoffset)])):(e.graphY1.unshift(0),e.graphY2.unshift(0));e.VERTEX_LENGTH=e.xscaleSlider.value},document.getElementById("xscaletd").style.display="none",document.getElementById("xscalebutton").style.display="none",document.getElementById("xoffsettd").style.display="none",document.getElementById("xoffsetbutton").style.display="none";function a(t,o=[100,100],i="Tooltip text"){var E="<div id='"+t+"_tooltip' class='tooltip'></div>";l.appendFragment(E,t);var y=document.getElementById(t+"_tooltip");y.innerHTML=i;var x=document.getElementById(t);y.style.left=o[0]+"px",y.style.top=o[1]+"px",y.style.display="none",x.onmouseover=()=>{y.style.display=""},x.onmouseleave=()=>{y.style.display="none"}}if(a("modal_opener",[50,70],"Session controls, timestamped annotating, save & replay data, host-changing, and an output table"),a("modal_opener2",[10,70],"Graph perspective controls"),a("modal_opener3",[10,90],"Various feedback modes. Change the scoring sensitivity settings in the Data menu to change the reactiveness."),a("commandrow",[10,100],"See documentation for a command list, not all work over WiFi."),a("sensitivityrow",[300,250],"Controls how reactive the feedback is to ratio changes."),a("timerow",[10,340],"Press 'Get Time' at any given time in your session then write a note and press 'Annotate' and it will be added to the CSV when you click 'Save CSV'"),a("csvrow",[10,520],"Name your CSV and save it after your session is complete to have a record of your data. Automatically stores in your default Downloads folder."),a("replaycsv",[10,575],"Replay saved CSV files (in our format) as if they are live sessions. For charting see our Data Charter applet on our repo or website."),a("hostrow",[10,575],"Connect to your device's WiFi IP manually from here to access the Event Source, it is automatically set when accessing this interface on the device. USB serial connectivity requires our free Chrome Extension. Alternate Bluetooth LE mode or BT serial connectivity also available."),a("xoffsettd",[10,40],"Scroll back and forth through your data if it is longer than the graph."),a("xscaletd",[10,80],"Shrink or grow the graph on the x-axis"),a("yoffsettd",[10,110],"Scroll up or down on the y-axis of the graph."),a("yscaletd",[10,160],"Shrink or grow the graph on the y-axis."),a("autoscaletd",[10,160],"Uncheck to manually scale the graph on the y-axis."),a("canvasmode",[10,10],"Grow the circle and keep it big!"),a("audiomode",[10,10],"Keep the song volume up or at a sweet spot! Use MP3 files."),a("txtmode",[10,10],"Scroll the text to the right to keep reading!"),a("videomode",[300,10],"Control a video through various means! Use MP4 files."),a("hillmode",[300,10],"Climb the mountain!"),a("boidsmode",[300,10],"Make the boids swirl together!"),b==!0&&a("threemode",[300,10],"Turn the Earth! More coming!"),a("wifibutton",[-150,40],"Connect to a device via WiFi, make sure you are connected to its local server or enter its IP in the Data menu if it's on a host network."),window.location.hostname!=="192.168.4.1"){var d=new P(!1);a("blebutton",[-150,40],"Connect to a device via Bluetooth LE!"),d.onNotificationCallback=t=>{var o=d.decoder.decode(t.target.value);d.android==!0&&(o=Date.now()+"|"+o),o.split(n.delimiter).length==n.header.length?n.handleEventData(o):console.log("BLE MSG: ",o)},d.onReadAsyncCallback=t=>{var o=t;d.android==!0&&(o=Date.now()+"|"+o),o.split(n.delimiter).length==n.header.length?n.handleEventData(o):console.log("BLE MSG: ",o)},d.onConnectedCallback=()=>{n.removeEventListeners(),d.android===!0&&(n.header=["ms","Red","IR","Ratio"],n.updateStreamHeader(),n.useMs=!0,e.usems=!0),document.getElementById("startbutton").onclick=()=>{d.sendMessage("t")},document.getElementById("stopbutton").onclick=()=>{d.sendMessage("f")},document.getElementById("sendbutton").onclick=()=>{d.sendMessage(document.getElementById("command").value)}},d.onDisconnected=()=>{d.android==!0&&(n.header=["us","Red","IR","Ratio","Ambient","drdt","ddrdt"],n.updateStreamHeader(),n.useMs=!1,e.useMs=!1),console.log("BLE Device disconnected!")}}if(chrome.serial||navigator.serial){var w='<div id="serialContainer" class="serialContainer"><h3>Serial Devices:</h3><div id="serialmenu" class="serialmenu"></div></div>';l.appendFragment(w,"main_body"),chrome.serial?a("serialContainer",[-220,10],"Click 'Get' to get available Serial devices and 'Set' to pair with it. Right click and press 'Inspect' to see debug output in the Console"):navigator.serial&&a("serialContainer",[-220,10],"Click to connect via the browser serial interface");var v=new L;v.finalCallback=()=>{n.removeEventListeners(),document.getElementById("startbutton").onclick=()=>{v.sendMessage("t")},document.getElementById("stopbutton").onclick=()=>{v.sendMessage("f")},document.getElementById("sendbutton").onclick=()=>{v.sendMessage(document.getElementById("command").value)},window.PEANUT?(v.sendMessage("protocol 3"),v.onReadLine=t=>{console.log(t)}):window.FREE_EEG32?v.onReadLine=t=>{}:v.onReadLine=t=>{t.split(n.delimiter).length==n.header.length?n.handleEventData(t):console.log("RECEIVED: ",t)}}}else if(navigator.userAgent.toLowerCase().indexOf("android")<0){var w='<div id="serialContainer" class="serialContainer"><h3>Enable Serial USB support (hover me)</h3></div>';l.appendFragment(w,"main_body"),a("serialContainer",[-220,10],"This feature is currently in beta, enable the #experimental-web-platform-features flag it via 'chrome://flags' or other chromium browsers (if supported).")}
